// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸš€ ë„¤ì´ë²„ ë¸”ë¡œê·¸ ìë™ ìƒì„± ì„œë²„ v4.6.1 (ì´ë¯¸ì§€ ë¶„ì„ ê°•í™”!)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// â­â­â­ NEW: ì´ë¯¸ì§€ ë¶„ì„ ëª…ì‹œì  ê°•í™”! (í˜„ì¥ê° UP!)
// â­â­â­ NEW: êµ¬ì²´ì ì¸ ì´ë¯¸ì§€ ë¬˜ì‚¬ ì§€ì‹œ!
// â­â­â­ NEW: Before/After ë¹„êµ ì‹œê°í™”!
// âœ… Claude ìê°€í‰ê°€ (14ê°œ í•­ëª©)
// âœ… ì„œë²„ ë ˆë²¨ ìë™ ê²€ì¦ (ì´ì¤‘ ì•ˆì „ì¥ì¹˜)
// âœ… 1íšŒ ìë™ ì¬ì‘ì„±
// âœ… í‰ê°€ ê²°ê³¼ í”„ë¡ íŠ¸ì—”ë“œ í‘œì‹œ
// ğŸ¯ í€„ë¦¬í‹° ëª©í‘œ: 98%+ (ì´ë¯¸ì§€ ë¶„ì„ + ìê°€í‰ê°€ + ì„œë²„ ê²€ì¦!)
// â±ï¸ ìµœëŒ€ ì‹œê°„: 60ì´ˆ (1ì°¨ 30ì´ˆ + 2ì°¨ 30ì´ˆ)
// ğŸ“… ìƒì„±: 2025-11-10 (v4.6 ê¸°ë°˜)
// ğŸ“‚ í˜¸í™˜: frontend_v8.3_ìŠ¤íŠ¸ë¦¬ë°_ë¡œì»¬í…ŒìŠ¤íŠ¸ìš©.html
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

require('dotenv').config();
const express = require('express');
const Anthropic = require('@anthropic-ai/sdk');
const multer = require('multer');
const path = require('path');
const cors = require('cors');
const fs = require('fs');

const app = express();
const PORT = process.env.PORT || 3000;

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ“š ê°€ì´ë“œë¼ì¸ íŒŒì¼ ë¡œë” v4.3 (ë©”ì¸ ì§€ì¹¨ì„œ ì¶”ê°€!)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

class GuidelineManager {
  constructor() {
    this.guidelinesPath = path.join(__dirname, 'guidelines');
    this.guidelines = {};
    this.loadAllGuidelines();
  }

  loadAllGuidelines() {
    console.log('\nğŸ“š ê°€ì´ë“œë¼ì¸ íŒŒì¼ ë¡œë”© ì¤‘...');
    
    try {
      // â­â­â­ 0. ë©”ì¸ ì§€ì¹¨ì„œ (ìµœìš°ì„ !)
      const files = {
        mainGuideline: '0__ë©”ì¸ì§€ì¹¨ì„œ_v8_2_í†µí•©ë³¸.md', // â­â­â­ NEW!
        
        // 1~10. ë³´ì¡° ê°€ì´ë“œ
        hooking: '1__í›„í‚¹_ì§ˆë¬¸_ë§ˆìŠ¤í„°_ê°€ì´ë“œ_v3_0.md',
        expressions: '2__ìœ ì‚¬ë¬¸ì„œ_ë°©ì§€_í‘œí˜„_ë¼ì´ë¸ŒëŸ¬ë¦¬_v1_1.md',
        company: '3__ì—…ì²´ì •ë³´_v1_1_ìˆ˜ì •ë³¸.md',
        ledLife: '4__LEDìˆ˜ëª…ì„¤ëª…_v1_1_ì™„ì „íŒ.md',
        ledTech: '5__LEDë¦¬í¼_ê¸°ìˆ ì‚¬ì–‘ì„œ_v2_4_ìˆ˜ì •ë³¸.md',
        checklist: '6__ì²´í¬ë¦¬ìŠ¤íŠ¸_ë¹ ë¥¸ì°¸ì¡°_v1_4_ì™„ì „íŒ.md',
        html: '7__HTML_ìŠ¤íƒ€ì¼_ê°€ì´ë“œ_v1_1.md',
        prohibited: '8__ê¸ˆì§€í‘œí˜„_ìë™ì²´í¬_v1_2_ì™„ì „íŒ.md',
        rotation: '9__í¬ìŠ¤íŒ…ë³„_í‘œí˜„_ìˆœí™˜_ê°€ì´ë“œ.md',
        evaluation: '10__ìê°€í‰ê°€_ì‹œìŠ¤í…œ_v2_0_ì™„ì „íŒ.md'
      };

      for (const [key, filename] of Object.entries(files)) {
        const filePath = path.join(this.guidelinesPath, filename);
        
        if (fs.existsSync(filePath)) {
          this.guidelines[key] = fs.readFileSync(filePath, 'utf8');
          const marker = key === 'mainGuideline' ? 'â­â­â­' : '   âœ…';
          console.log(`${marker} ${key}: ${filename} (${Math.round(this.guidelines[key].length / 1024)}KB)`);
        } else {
          console.log(`   âš ï¸ ${key}: ${filename} - íŒŒì¼ ì—†ìŒ`);
          this.guidelines[key] = '';
        }
      }

      console.log(`\nâœ… ê°€ì´ë“œë¼ì¸ ë¡œë“œ ì™„ë£Œ: ${Object.keys(this.guidelines).length}ê°œ`);
      console.log(`   ë©”ì¸ ì§€ì¹¨ì„œ: ${this.guidelines.mainGuideline ? 'ë¡œë“œë¨ â­â­â­' : 'ì—†ìŒ âŒ'}`);
      console.log(`   ì´ í¬ê¸°: ${Math.round(Object.values(this.guidelines).join('').length / 1024)}KB\n`);
      
    } catch (error) {
      console.error('âŒ ê°€ì´ë“œë¼ì¸ ë¡œë“œ ì‹¤íŒ¨:', error.message);
      console.error('   ê¸°ë³¸ ê·œì¹™ìœ¼ë¡œ í´ë°±í•©ë‹ˆë‹¤.\n');
    }
  }

  // ë””ë°ìŠ¤ìœ„ì¹˜ ì•„íŒŒíŠ¸ í™•ì¸
  isDimmingApartment(complexName) {
    if (!complexName) return false;
    
    const dimmingApts = [
      'í¼ìŠ¤íŠ¸ì›”ë“œ',
      'ì—‘ìŠ¤í¬6ë‹¨ì§€', 'ì—‘ìŠ¤í¬ 6ë‹¨ì§€',
      'ì—‘ìŠ¤í¬9ë‹¨ì§€', 'ì—‘ìŠ¤í¬ 9ë‹¨ì§€',
      'ì—‘ìŠ¤í¬10ë‹¨ì§€', 'ì—‘ìŠ¤í¬ 10ë‹¨ì§€',
      'ì„¼íŠ¸ëŸ´íŒŒí¬1ì°¨', 'ì„¼íŠ¸ëŸ´íŒŒí¬ 1ì°¨',
      'ì„¼íŠ¸ëŸ´íŒŒí¬2ì°¨', 'ì„¼íŠ¸ëŸ´íŒŒí¬ 2ì°¨',
      'ì›°ì¹´ìš´í‹°1ë‹¨ì§€', 'ì›°ì¹´ìš´í‹° 1ë‹¨ì§€',
      'ì›°ì¹´ìš´í‹°2ë‹¨ì§€', 'ì›°ì¹´ìš´í‹° 2ë‹¨ì§€',
      'ì›°ì¹´ìš´í‹°3ë‹¨ì§€', 'ì›°ì¹´ìš´í‹° 3ë‹¨ì§€',
      'ì›°ì¹´ìš´í‹°4ë‹¨ì§€', 'ì›°ì¹´ìš´í‹° 4ë‹¨ì§€'
    ];

    return dimmingApts.some(apt => 
      complexName.replace(/\s/g, '').includes(apt.replace(/\s/g, ''))
    );
  }

  // ìƒí™©ë³„ í•„ìš”í•œ ê°€ì´ë“œ ì„ íƒ
  selectRelevantGuidelines(data) {
    const selected = [];
    const { postingType, complexName, spaceData } = data;

    // â­â­â­ 0. ë©”ì¸ ì§€ì¹¨ì„œ (í•­ìƒ ìµœìš°ì„  í¬í•¨!)
    if (this.guidelines.mainGuideline) {
      selected.push({
        name: 'ğŸ“˜ ë©”ì¸ ì§€ì¹¨ì„œ v8.2 í†µí•©ë³¸',
        content: this.guidelines.mainGuideline,
        priority: 'CRITICAL' // â­ ìµœìš°ì„ 
      });
    }

    // 1. í•­ìƒ í•„ìš”í•œ ê°€ì´ë“œ
    if (this.guidelines.hooking) {
      selected.push({
        name: 'í›„í‚¹ ì§ˆë¬¸ ê°€ì´ë“œ',
        content: this.guidelines.hooking
      });
    }

    if (this.guidelines.company) {
      selected.push({
        name: 'íšŒì‚¬ ë ˆí¼ëŸ°ìŠ¤ ê°€ì´ë“œ',
        content: this.guidelines.company
      });
    }

    if (this.guidelines.ledLife) {
      selected.push({
        name: 'LED ìˆ˜ëª… í‘œí˜„ ê°€ì´ë“œ',
        content: this.guidelines.ledLife
      });
    }

    // 2. ë””ë°ìŠ¤ìœ„ì¹˜ ì•„íŒŒíŠ¸ë©´ ì¶”ê°€
    if (this.isDimmingApartment(complexName)) {
      console.log('   ğŸ” ë””ë°ìŠ¤ìœ„ì¹˜ ì•„íŒŒíŠ¸ ê°ì§€!');
      if (this.guidelines.ledTech) {
        selected.push({
          name: 'LED ê¸°ìˆ ì‚¬ì–‘ì„œ (ë””ë°ìŠ¤ìœ„ì¹˜ ì£¼ì˜ì‚¬í•­)',
          content: this.guidelines.ledTech
        });
      }
    }

    // 3. ì‚¬ë¡€í˜•ì´ë©´ ì¶”ê°€
    if (postingType === 'ì‚¬ë¡€í˜•') {
      if (this.guidelines.ledTech && !this.isDimmingApartment(complexName)) {
        selected.push({
          name: 'LED ê¸°ìˆ ì‚¬ì–‘ì„œ',
          content: this.guidelines.ledTech
        });
      }
      
      // â­ ìê°€í‰ê°€ ì‹œìŠ¤í…œ í•„ìˆ˜!
      if (this.guidelines.evaluation) {
        selected.push({
          name: 'ìê°€í‰ê°€ ì‹œìŠ¤í…œ v2.0',
          content: this.guidelines.evaluation,
          priority: 'HIGH' // â­ ë†’ì€ ìš°ì„ ìˆœìœ„
        });
      }
    }

    // 4. í‘œí˜„ ìˆœí™˜ ê°€ì´ë“œ
    if (this.guidelines.rotation) {
      selected.push({
        name: 'í‘œí˜„ ìˆœí™˜ ê°€ì´ë“œ',
        content: this.guidelines.rotation
      });
    }

    // 5. ê¸ˆì§€í‘œí˜„ ì²´í¬
    if (this.guidelines.prohibited) {
      selected.push({
        name: 'ê¸ˆì§€í‘œí˜„ ì²´í¬',
        content: this.guidelines.prohibited
      });
    }

    return selected;
  }

  // ì„ íƒëœ ê°€ì´ë“œë¥¼ í”„ë¡¬í”„íŠ¸ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  formatGuidelines(selected) {
    if (selected.length === 0) {
      return '';
    }

    let formatted = '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
    formatted += 'ğŸ“š ìƒì„¸ ê°€ì´ë“œë¼ì¸ (ìƒí™©ë³„ ì„ íƒ)\n';
    formatted += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

    // ìš°ì„ ìˆœìœ„ë³„ ì •ë ¬
    selected.sort((a, b) => {
      const priorityOrder = { 'CRITICAL': 0, 'HIGH': 1, 'NORMAL': 2 };
      return (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2);
    });

    selected.forEach((guide, idx) => {
      const priorityMark = guide.priority === 'CRITICAL' ? ' â­â­â­' : 
                          guide.priority === 'HIGH' ? ' â­' : '';
      formatted += `â”â”â” ${idx + 1}. ${guide.name}${priorityMark} â”â”â”\n\n`;
      formatted += guide.content;
      formatted += '\n\n';
    });

    return formatted;
  }
}

// ê°€ì´ë“œë¼ì¸ ë§¤ë‹ˆì € ì´ˆê¸°í™”
const guidelineManager = new GuidelineManager();

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ“‹ í•µì‹¬ ê·œì¹™ (ê°„ë‹¨ ìš”ì•½)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

const CORE_GUIDELINES = `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“˜ ë„¤ì´ë²„ ë¸”ë¡œê·¸ ì½˜í…ì¸  ì‘ì„± í•µì‹¬ ê·œì¹™ v8.2
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ìµœì¢… ì—…ë°ì´íŠ¸: 2025-11-07
í’ˆì§ˆ ëª©í‘œ: 90-98% (ë©”ì¸ ì§€ì¹¨ì„œ + ìê°€í‰ê°€ í™œìš©)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸âš ï¸âš ï¸ ì•„ë˜ì— ë©”ì¸ ì§€ì¹¨ì„œ v8.2 í†µí•©ë³¸ì´ ì œê³µë©ë‹ˆë‹¤!
ë©”ì¸ ì§€ì¹¨ì„œì˜ ëª¨ë“  ê·œì¹™ì„ ì² ì €íˆ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤!
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ“¦ Multer ì„¤ì •
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

const storage = multer.memoryStorage();
const upload = multer({
  storage: storage,
  limits: {
    fileSize: 10 * 1024 * 1024,
  }
});

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ”§ ë¯¸ë“¤ì›¨ì–´
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

app.use(cors());
app.use(express.static('public'));
app.use(express.json());

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ¤– Claude API ì´ˆê¸°í™”
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ”§ í—¬í¼ í•¨ìˆ˜ë“¤
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

function parseInputData(req) {
  try {
    const dataString = req.body.data;
    if (!dataString) {
      throw new Error('data í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤');
    }
    const parsed = JSON.parse(dataString);
    
    if (!parsed.postingType) {
      parsed.postingType = 'ì‚¬ë¡€í˜•';
      console.log('âš ï¸ íƒ€ì… ì—†ìŒ â†’ ê¸°ë³¸ê°’ "ì‚¬ë¡€í˜•" ì„¤ì •');
    }
    
    console.log('ğŸ“Š íŒŒì‹±ëœ ë°ì´í„°:');
    console.log('   - postingType:', parsed.postingType);
    console.log('   - keyword:', parsed.keyword);
    console.log('   - complexName:', parsed.complexName);
    console.log('   - spaceData:', parsed.spaceData ? `${parsed.spaceData.length}ê°œ` : 'ì—†ìŒ');
    
    return parsed;
  } catch (error) {
    console.error('âŒ JSON íŒŒì‹± ì—ëŸ¬:', error.message);
    throw new Error('ì…ë ¥ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨: ' + error.message);
  }
}

function processImages(files) {
  if (!files || files.length === 0) {
    return [];
  }

  return files.map(file => {
    const base64Data = file.buffer.toString('base64');
    
    let fileName = file.originalname;
    try {
      fileName = Buffer.from(file.originalname, 'latin1').toString('utf8');
    } catch (e) {
      console.log('âš ï¸ íŒŒì¼ëª… ì¸ì½”ë”© ë³€í™˜ ì‹¤íŒ¨, ì›ë³¸ ì‚¬ìš©:', file.originalname);
    }
    
    return {
      name: fileName,
      data: base64Data,
      mimeType: file.mimetype
    };
  });
}

function createTextPrompt(data, images) {
  const { 
    keyword, 
    postingType,
    complexName, 
    spaceData,
    additionalWork,
    constructionReason,
    customerReview,
    specialNote
  } = data;

  // â­ ìƒí™©ë³„ ê°€ì´ë“œ ì„ íƒ
  console.log('\nğŸ“š ìƒí™©ë³„ ê°€ì´ë“œ ì„ íƒ ì¤‘...');
  const selectedGuidelines = guidelineManager.selectRelevantGuidelines(data);
  console.log(`âœ… ì„ íƒëœ ê°€ì´ë“œ: ${selectedGuidelines.length}ê°œ`);
  selectedGuidelines.forEach((g, idx) => {
    const priorityMark = g.priority === 'CRITICAL' ? ' â­â­â­' : 
                        g.priority === 'HIGH' ? ' â­' : '';
    console.log(`   ${idx + 1}. ${g.name}${priorityMark} (${Math.round(g.content.length / 1024)}KB)`);
  });

  // â­ ê°€ì´ë“œë¥¼ í”„ë¡¬í”„íŠ¸ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  const formattedGuidelines = guidelineManager.formatGuidelines(selectedGuidelines);
  const totalGuidelineSize = formattedGuidelines.length;
  console.log(`\nğŸ“ í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€ë  ê°€ì´ë“œ í¬ê¸°: ${Math.round(totalGuidelineSize / 1024)}KB`);

  // ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ì‹œì‘
  let prompt = `${CORE_GUIDELINES}\n`;
  
  // â­ ìƒì„¸ ê°€ì´ë“œ ì¶”ê°€
  prompt += formattedGuidelines;
  
  prompt += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  prompt += `ğŸ“‹ ì‚¬ìš©ì ì…ë ¥ ì •ë³´\n`;
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  prompt += `ë©”ì¸ í‚¤ì›Œë“œ: ${keyword}\n`;
  prompt += `í¬ìŠ¤íŒ… íƒ€ì…: ${postingType}\n`;
  
  if (complexName) {
    prompt += `ë‹¨ì§€ëª…: ${complexName}\n`;
    
    // â­ ë””ë°ìŠ¤ìœ„ì¹˜ ì•„íŒŒíŠ¸ ê²½ê³ 
    if (guidelineManager.isDimmingApartment(complexName)) {
      prompt += `\nâš ï¸âš ï¸âš ï¸ ë””ë°ìŠ¤ìœ„ì¹˜ ì•„íŒŒíŠ¸ì…ë‹ˆë‹¤! âš ï¸âš ï¸âš ï¸\n`;
      prompt += `ì ˆëŒ€ ê¸ˆì§€: "ë°ê¸° ì¡°ì ˆ ê¸°ëŠ¥ ìœ ì§€" ê°™ì€ í‘œí˜„\n`;
      prompt += `ì˜¬ë°”ë¥¸ í‘œí˜„: "ìŠ¤ìœ„ì¹˜ êµì²´ ì—†ì´", "ì¶”ê°€ ê³µì‚¬ ì—†ì´"\n\n`;
    }
  }
  
  if (images && images.length > 0) {
    prompt += `\n[ì—…ë¡œë“œëœ ì‚¬ì§„ íŒŒì¼ëª…]\n`;
    images.forEach((img, idx) => {
      prompt += `${idx + 1}. ${img.name}\n`;
    });
  }
  
  if (spaceData && spaceData.length > 0) {
    prompt += `\n[ê³µê°„ë³„ ë°ì´í„°]\n`;
    spaceData.forEach((space, idx) => {
      prompt += `\n${idx + 1}. ${space.space || space.spaceName}\n`;
      prompt += `   - ì‹œê³µ ìœ í˜•: ${space.constructionType || space.workType}\n`;
      
      if (space.fixture) {
        prompt += `   - ë“±ê¸°êµ¬: ${space.fixture}\n`;
      }
      if (space.oldProduct) {
        prompt += `   - ê¸°ì¡´ ì œí’ˆ: ${space.oldProduct}\n`;
      }
      if (space.newProduct) {
        prompt += `   - ì‹ ê·œ ì œí’ˆ: ${space.newProduct}\n`;
      }
      
      prompt += `   - ê¸°ì¡´ ì†Œë¹„ì „ë ¥: ${space.oldPower}W\n`;
      prompt += `   - êµì²´ í›„ ì†Œë¹„ì „ë ¥: ${space.newPower}W\n`;
      prompt += `   - ì ˆê°: ${space.oldPower - space.newPower}W\n`;
      
      if (space.oldLux) {
        prompt += `   - ì„¤ì¹˜ ì „ ì¡°ë„: ${space.oldLux} lux\n`;
      }
      if (space.newLux) {
        prompt += `   - ì„¤ì¹˜ í›„ ì¡°ë„: ${space.newLux} lux\n`;
      }
      if (space.colorTemp) {
        prompt += `   - ìƒ‰ì˜¨ë„: ${space.colorTemp}\n`;
      }
    });
  }
  
  if (additionalWork) {
    prompt += `\n[ì¶”ê°€ ì‘ì—… ì •ë³´]\n`;
    if (typeof additionalWork === 'object') {
      Object.entries(additionalWork).forEach(([key, value]) => {
        prompt += `- ${key}: ${value}\n`;
      });
    } else {
      prompt += `${additionalWork}\n`;
    }
  }
  
  if (constructionReason) {
    prompt += `\n[ì‹œê³µ ì‚¬ìœ ]\n${constructionReason}\n`;
  }
  
  if (customerReview) {
    prompt += `\n[ê³ ê° í›„ê¸°]\n${customerReview}\n`;
  }
  
  if (specialNote) {
    prompt += `\n[íŠ¹ì´ì‚¬í•­]\n${specialNote}\n`;
  }
  
  prompt += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  prompt += `âœï¸ ì‘ì„± ì§€ì‹œ\n`;
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  prompt += `ìœ„ì˜ ë©”ì¸ ì§€ì¹¨ì„œ v8.2ì™€ ìƒì„¸ ê°€ì´ë“œë¼ì¸, ê·¸ë¦¬ê³  ì‚¬ìš©ì ì…ë ¥ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ\n`;
  prompt += `ë„¤ì´ë²„ ë¸”ë¡œê·¸ í¬ìŠ¤íŒ…ì„ ì‘ì„±í•˜ì„¸ìš”.\n\n`;
  
  prompt += `âš ï¸âš ï¸âš ï¸ ë©”ì¸ ì§€ì¹¨ì„œ v8.2ë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ë”°ë¥´ì„¸ìš”!\n`;
  prompt += `ë©”ì¸ ì§€ì¹¨ì„œì˜ ëª¨ë“  ê·œì¹™, íŠ¹íˆ ë‹¤ìŒ ì‚¬í•­ë“¤ì„ ì² ì €íˆ ì¤€ìˆ˜í•˜ì„¸ìš”:\n`;
  prompt += `- ë©”ì¸í‚¤ì›Œë“œ "${keyword}" 5~6íšŒ ë°°ì¹˜ (ìµœì†Œ 4íšŒ, ìµœëŒ€ 10íšŒ)\n`;
  prompt += `- ì œëª©ì— ë©”ì¸í‚¤ì›Œë“œ ë§¨ ì• ë°°ì¹˜\n`;
  prompt += `- í›„í‚¹ ì§ˆë¬¸ 3ê°œ (ëª¨ë‘ ?ë¡œ ë)\n`;
  prompt += `- íšŒì‚¬ ë ˆí¼ëŸ°ìŠ¤ 2ë¬¸ë‹¨\n`;
  prompt += `- ë””ë° ê¸°ëŠ¥ í‘œí˜„ ê¸ˆì§€\n`;
  prompt += `- LED ìˆ˜ëª… 2ê³³ ë°°ì¹˜\n`;
  prompt += `- ê³ ì • ì´ë¯¸ì§€ 4ì¢… ë°°ì¹˜\n`;
  prompt += `- íœ´ë¨¼ë¼ì´í¬ 4ëŒ€ ìš”ì†Œ (êµ¬ì–´ì²´, ì²´ì–¸ ì¢…ê²°, ê°íƒ„ì‚¬, ë¬¸ì¥ ê¸¸ì´)\n\n`;
  
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  prompt += `ğŸ–¼ï¸â­â­â­ ì´ë¯¸ì§€ ë¶„ì„ ë° í™œìš© ê·œì¹™ (ë§¤ìš° ì¤‘ìš”!)\n`;
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  prompt += `ì‚¬ì§„ì´ ì²¨ë¶€ëœ ê²½ìš°, ë°˜ë“œì‹œ ë‹¤ìŒ ê·œì¹™ì„ ë”°ë¥´ì„¸ìš”:\n\n`;
  
  prompt += `1ï¸âƒ£ ì´ë¯¸ì§€ë¥¼ ì‹¤ì œë¡œ ë³´ê³  ë¶„ì„í•˜ì„¸ìš”! (í•„ìˆ˜!)\n`;
  prompt += `   - ì—…ë¡œë“œëœ ì´ë¯¸ì§€ëŠ” ë‹¨ìˆœí•œ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤\n`;
  prompt += `   - ê° ì´ë¯¸ì§€ì˜ ë‚´ìš©ì„ ì‹¤ì œë¡œ ê´€ì°°í•˜ê³  ë¶„ì„í•˜ì„¸ìš”\n`;
  prompt += `   - ë³´ì´ëŠ” ê²ƒì„ êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬í•˜ì„¸ìš”\n\n`;
  
  prompt += `2ï¸âƒ£ ì„¤ì¹˜ ì „ ì´ë¯¸ì§€ ë¶„ì„ í¬ì¸íŠ¸:\n`;
  prompt += `   âœ… ê¸°ì¡´ ì¡°ëª…ì˜ ë°ê¸° ìƒíƒœ (ì–´ë‘¡ë‹¤, íë¦¿í•˜ë‹¤, ê·¸ë¦¼ìê°€ ìˆë‹¤ ë“±)\n`;
  prompt += `   âœ… ì¡°ëª… ìƒ‰ìƒ (ëˆ„ëŸ° í˜•ê´‘ë“± ë¹›, ì°¨ê°€ìš´ í°ë¹› ë“±)\n`;
  prompt += `   âœ… ì–´ë‘ìš´ ì˜ì—­ì´ ì–´ë””ì¸ì§€ (ì†ŒíŒŒ ë’¤, TVì¥ ì˜†, ì½”ë„ˆ ë“±)\n`;
  prompt += `   âœ… ê³µê°„ì˜ ì „ì²´ì ì¸ ë¶„ìœ„ê¸°\n`;
  prompt += `   ì˜ˆì‹œ: "ì†ŒíŒŒ ë’¤í¸ê³¼ TVì¥ ì£¼ë³€ì´ ì–´ë‘ì›Œ ê·¸ë¦¼ìê°€ ì§€ê³  ìˆìŠµë‹ˆë‹¤"\n\n`;
  
  prompt += `3ï¸âƒ£ ì‘ì—… ì¤‘ ì´ë¯¸ì§€ ë¶„ì„ í¬ì¸íŠ¸:\n`;
  prompt += `   âœ… ì‘ì—…ìê°€ ë¬´ì—‡ì„ í•˜ê³  ìˆëŠ”ì§€ (í™•ì‚°íŒ ë¶„ë¦¬, ë°°ì„  ì‘ì—… ë“±)\n`;
  prompt += `   âœ… ë³´ì´ëŠ” ë¶€í’ˆì´ë‚˜ ë„êµ¬ (LED ëª¨ë“ˆ, SMPS, ê³µêµ¬ ë“±)\n`;
  prompt += `   âœ… ì²œì¥ì´ë‚˜ ë“±ê¸°êµ¬ì˜ ìƒíƒœ\n`;
  prompt += `   ì˜ˆì‹œ: "ì²œì¥ì—ì„œ í™•ì‚°íŒì„ ë¶„ë¦¬í•˜ê³  ê¸°ì¡´ í˜•ê´‘ë“±ì„ ì œê±°í•˜ëŠ” ëª¨ìŠµì…ë‹ˆë‹¤"\n\n`;
  
  prompt += `4ï¸âƒ£ ì„¤ì¹˜ í›„ ì´ë¯¸ì§€ ë¶„ì„ í¬ì¸íŠ¸:\n`;
  prompt += `   âœ… ìƒˆë¡œìš´ ì¡°ëª…ì˜ ë°ê¸° (ì„¤ì¹˜ ì „ê³¼ í™•ì‹¤íˆ ë¹„êµ)\n`;
  prompt += `   âœ… ë¹›ì˜ í™•ì‚° ì •ë„ (ê· ì¼í•œì§€, êµ¬ì„ê¹Œì§€ ë°ì€ì§€)\n`;
  prompt += `   âœ… ìƒ‰ì˜¨ë„ì˜ ëŠë‚Œ (ë”°ëœ»í•œì§€, ì‹œì›í•œì§€, ìì—°ìŠ¤ëŸ¬ìš´ì§€)\n`;
  prompt += `   âœ… ì´ì „ì— ì–´ë‘ì› ë˜ ê³³ì´ ë°ì•„ì¡ŒëŠ”ì§€\n`;
  prompt += `   ì˜ˆì‹œ: "ì´ì „ì— ì–´ë‘ì› ë˜ ì†ŒíŒŒ ë’¤í¸ê¹Œì§€ ë°ê²Œ ë¹„ì¶”ë©° ê·¸ë¦¼ìê°€ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤"\n\n`;
  
  prompt += `5ï¸âƒ£ í˜„ì¥ê° ìˆëŠ” ë¬˜ì‚¬ (í•„ìˆ˜!):\n`;
  prompt += `   âŒ ë‚˜ìœ ì˜ˆ: "LED ì¡°ëª…ì„ ì„¤ì¹˜í–ˆìŠµë‹ˆë‹¤"\n`;
  prompt += `   âœ… ì¢‹ì€ ì˜ˆ: "ê±°ì‹¤ ì „ì²´ê°€ í™˜í•˜ê²Œ ë°ì•„ì§€ë©´ì„œ, ì´ì „ì—ëŠ” ì–´ë‘ì› ë˜ \n`;
  prompt += `                ì†ŒíŒŒ ë’¤í¸ê³¼ TVì¥ ì˜†ê¹Œì§€ ë¹›ì´ ê³ ë¥´ê²Œ í¼ì ¸ ê³µê°„ì´ \n`;
  prompt += `                ë„“ì–´ ë³´ì…ë‹ˆë‹¤"\n\n`;
  
  prompt += `   âŒ ë‚˜ìœ ì˜ˆ: "ì‘ì—…ì„ ì§„í–‰í–ˆìŠµë‹ˆë‹¤"\n`;
  prompt += `   âœ… ì¢‹ì€ ì˜ˆ: "ì²œì¥ì—ì„œ í™•ì‚°íŒì„ ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ë¶„ë¦¬í•œ í›„, ê¸°ì¡´ í˜•ê´‘ë“±ì„ \n`;
  prompt += `                ì œê±°í•˜ê³  ì•ˆì „í•˜ê²Œ ë°°ì„  ì‘ì—…ì„ ì§„í–‰í–ˆìŠµë‹ˆë‹¤"\n\n`;
  
  prompt += `6ï¸âƒ£ Before/After ë¹„êµ (ì„¤ì¹˜ í›„ ì„¹ì…˜ì—ì„œ):\n`;
  prompt += `   - ì„¤ì¹˜ ì „ ì´ë¯¸ì§€ì—ì„œ ë³¸ ê²ƒê³¼ ì„¤ì¹˜ í›„ë¥¼ ì§ì ‘ ë¹„êµí•˜ì„¸ìš”\n`;
  prompt += `   - "ì´ì „ì—ëŠ” [ê´€ì°°í•œ ê²ƒ], ì´ì œëŠ” [ê°œì„ ëœ ê²ƒ]" í˜•íƒœë¡œ ì‘ì„±\n`;
  prompt += `   ì˜ˆì‹œ: "ì„¤ì¹˜ ì „ ì–´ë‘ì› ë˜ ê±°ì‹¤ì´ ì´ì œëŠ” í™˜í•˜ê²Œ ë°ì•„ì¡Œê³ , \n`;
  prompt += `          íŠ¹íˆ ì½”ë„ˆ ë¶€ë¶„ê¹Œì§€ ë¹›ì´ ë‹¿ì•„ ê³µê°„ì´ ë” ë„“ì–´ ë³´ì…ë‹ˆë‹¤"\n\n`;
  
  prompt += `7ï¸âƒ£ ì´ë¯¸ì§€ ë°°ì¹˜ í˜•ì‹:\n`;
  prompt += `   - ê° ì´ë¯¸ì§€ë¥¼ ì„¤ëª…í•˜ê¸° ì „ì— [ì´ë¯¸ì§€: íŒŒì¼ëª….jpg] í˜•íƒœë¡œ í‘œì‹œ\n`;
  prompt += `   - ìœ„ì˜ [ì—…ë¡œë“œëœ ì‚¬ì§„ íŒŒì¼ëª…] ëª©ë¡ì˜ ì‹¤ì œ íŒŒì¼ëª…ì„ ì •í™•íˆ ì‚¬ìš©\n`;
  prompt += `   - íŒŒì¼ëª…ì„ ì„ì˜ë¡œ ë³€ê²½í•˜ê±°ë‚˜ ì¶”ì¸¡í•˜ì§€ ë§ ê²ƒ\n\n`;
  
  prompt += `âš ï¸âš ï¸âš ï¸ í•µì‹¬: ë…ìê°€ í˜„ì¥ì— ìˆëŠ” ê²ƒì²˜ëŸ¼ ìƒìƒí•˜ê²Œ!\n`;
  prompt += `ì´ë¯¸ì§€ë¥¼ ë‹¨ìˆœíˆ "ë°°ì¹˜"ë§Œ í•˜ì§€ ë§ê³ , ì‹¤ì œë¡œ "ë¶„ì„"í•˜ê³  "ë¬˜ì‚¬"í•˜ì„¸ìš”!\n`;
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  if (specialNote) {
    prompt += `â­â­â­ íŠ¹ì´ì‚¬í•­ ë°˜ì˜ ê·œì¹™ (ë§¤ìš° ì¤‘ìš”!):\n`;
    prompt += `[íŠ¹ì´ì‚¬í•­]ì— ì…ë ¥ëœ ë‚´ìš©ì€ ë°˜ë“œì‹œ í¬ìŠ¤íŒ…ì— ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ë‚´ì„¸ìš”.\n`;
    prompt += `- ê³ ê°ì˜ ì¶”ê°€ ë°œì–¸ì´ë‚˜ í›„ê¸°ê°€ ìˆë‹¤ë©´ "ì„¤ì¹˜ í›„" ì„¹ì…˜ì´ë‚˜ ë§ˆë¬´ë¦¬ ë¶€ë¶„ì— ì¸ìš© í˜•íƒœë¡œ í¬í•¨í•˜ì„¸ìš”.\n`;
    prompt += `- íŠ¹ìˆ˜ ì‹œê³µ ì¡°ê±´ì´ë‚˜ ìš”ì²­ì‚¬í•­ì´ ìˆë‹¤ë©´ í•´ë‹¹ ê³µê°„ì˜ "ì‘ì—… ì¤‘" ë˜ëŠ” "ì„¤ì¹˜ í›„" ì„¹ì…˜ì—ì„œ ì„¤ëª…í•˜ì„¸ìš”.\n`;
    prompt += `- ì¶”ê°€ ì‹œê³µ ë‚´ìš©(ì˜ˆ: ì£¼ë°©ë“± ì¶”ê°€ ì‹œê³µ)ì´ ì–¸ê¸‰ë˜ì—ˆë‹¤ë©´ ë§ˆë¬´ë¦¬ ë¶€ë¶„ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì–¸ê¸‰í•˜ì„¸ìš”.\n`;
    prompt += `íŠ¹ì´ì‚¬í•­ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ì§€ ë§ê³ , í¬ìŠ¤íŒ… í†¤ì— ë§ê²Œ ìì—°ìŠ¤ëŸ½ê²Œ ì¬ì‘ì„±í•˜ì—¬ ë°˜ì˜í•˜ì„¸ìš”.\n\n`;
  }
  
  // â­â­â­ NEW: H3 ê´€ë ¨ ì£¼ì˜ì‚¬í•­
  prompt += `âš ï¸âš ï¸âš ï¸ H3 ì œëª© ì‘ì„± ê·œì¹™ (ë§¤ìš° ì¤‘ìš”!):\n`;
  prompt += `ì‚¬ë¡€í˜• í¬ìŠ¤íŒ…ì—ì„œ "ì„¤ì¹˜ ì „/ì¤‘/í›„" ì œëª©ì€ ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ì„¸ìš”:\n`;
  prompt += `âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ:\n`;
  prompt += `### ì„¤ì¹˜ ì „\n`;
  prompt += `### ì„¤ì¹˜ ì¤‘\n`;
  prompt += `### ì„¤ì¹˜ í›„\n\n`;
  prompt += `âŒ ì˜ëª»ëœ ì˜ˆì‹œ (ì ˆëŒ€ ê¸ˆì§€!):\n`;
  prompt += `### H3 ì„¤ì¹˜ ì „  â† "H3" í…ìŠ¤íŠ¸ ë¶™ì´ë©´ ì•ˆ ë¨!\n`;
  prompt += `### H3 ì„¤ì¹˜ ì¤‘  â† "H3" í…ìŠ¤íŠ¸ ë¶™ì´ë©´ ì•ˆ ë¨!\n`;
  prompt += `### H3 ì„¤ì¹˜ í›„  â† "H3" í…ìŠ¤íŠ¸ ë¶™ì´ë©´ ì•ˆ ë¨!\n\n`;
  prompt += `"H3"ëŠ” ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•ì¼ ë¿, ì‹¤ì œ ì œëª©ì— í¬í•¨ì‹œí‚¤ë©´ ì•ˆ ë©ë‹ˆë‹¤!\n\n`;
  
  prompt += `â­â­â­ ì¶œë ¥ í˜•ì‹:\n`;
  prompt += `ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.\n`;
  prompt += `HTMLì€ ìƒì„±í•˜ì§€ ë§ˆì„¸ìš”. ì˜¤ì§ ë§ˆí¬ë‹¤ìš´ë§Œ ì¶œë ¥í•˜ì„¸ìš”.\n\n`;
  
  // â­â­â­ NEW: ìê°€í‰ê°€ ì‹¤í–‰ ëª…ë ¹ v2.0 ì™„ì „íŒ!
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  prompt += `âš ï¸âš ï¸âš ï¸ ì‘ì„± ì™„ë£Œ í›„ 3ë‹¨ê³„ ìê°€í‰ê°€ ì‹œìŠ¤í…œ v2.0 (í•„ìˆ˜!)\n`;
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  prompt += `í¬ìŠ¤íŒ… ì‘ì„± ì™„ë£Œ í›„ ë°˜ë“œì‹œ ë‹¤ìŒ 3ë‹¨ê³„ í‰ê°€ë¥¼ ìˆ˜í–‰í•˜ì„¸ìš”:\n\n`;
  
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  prompt += `[Level 1] ì¹˜ëª…ì  í˜•ì‹ ì²´í¬ (2ê°œ) - ì¦‰ì‹œ ì¬ì‘ì„±!\n`;
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  prompt += `1ï¸âƒ£ LED ìˆ˜ëª… ê¸ˆì§€í‘œí˜„:\n`;
  prompt += `   - "10ë…„", "ë°˜ì˜êµ¬", "50,000ì‹œê°„", "í‰ìƒ", "ë¬´ê±±ì •", "ê±°ì˜ ê³ ì¥ ì•ˆ" ê²€ìƒ‰\n`;
  prompt += `   - 1ê°œë¼ë„ ë°œê²¬: âŒ ì¦‰ì‹œ ì‚­ì œí•˜ê³  "2ë…„ AS ë³´ì¦"ìœ¼ë¡œ êµì²´\n\n`;
  
  prompt += `2ï¸âƒ£ í›„í‚¹ ì§ˆë¬¸ ë¬¼ìŒí‘œ:\n`;
  prompt += `   - 3ê°œ ëª¨ë‘ "?"ë¡œ ëë‚˜ëŠ”ì§€ í™•ì¸\n`;
  prompt += `   - í‰ì„œë¬¸ 1ê°œë¼ë„ ìˆìœ¼ë©´: âŒ ì¦‰ì‹œ ìˆ˜ì •\n\n`;
  
  prompt += `â†’ Level 1 ì˜¤ë¥˜ ë°œê²¬ ì‹œ: ì¦‰ì‹œ ìˆ˜ì • í›„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰\n\n`;
  
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  prompt += `[Level 2] í•„ìˆ˜ í˜•ì‹ ì²´í¬ (6ê°œ) - ì¶”ê°€ í•„ìš”!\n`;
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  prompt += `3ï¸âƒ£ ì‚¬ì§„ ì—…ë¡œë“œ (ì‚¬ë¡€í˜•ë§Œ):\n`;
  prompt += `   - ì„¤ì¹˜ ì „ ìµœì†Œ 1ì¥, ì‘ì—… ì¤‘ ìµœì†Œ 2ì¥, ì„¤ì¹˜ í›„ ìµœì†Œ 2ì¥\n\n`;
  
  prompt += `4ï¸âƒ£ ê³ ì • ì´ë¯¸ì§€ 4ì¢…:\n`;
  prompt += `   - [GIF: ì—…ì²´ì†Œê°œ.gif], [ì¸ë„¤ì¼: ëŒ€í‘œì´ë¯¸ì§€.jpg]\n`;
  prompt += `   - [GIF: ì¡°ë„ë¹„êµ.gif], [ë°°ë„ˆ: ë¬¸ì˜ë°°ë„ˆ.jpg] (ì‚¬ë¡€í˜•ë§Œ)\n\n`;
  
  prompt += `5ï¸âƒ£ LED ìˆ˜ëª… ë°°ì¹˜ 2ê³³:\n`;
  prompt += `   - ì†Œë¹„ì „ë ¥ í‘œ ë‹¤ìŒ + í¬ìŠ¤íŒ… ë (2ê³³)\n\n`;
  
  prompt += `6ï¸âƒ£ íšŒì‚¬ ë ˆí¼ëŸ°ìŠ¤ 2ë¬¸ë‹¨:\n`;
  prompt += `   - GIF ìœ„ 1ë¬¸ë‹¨ + GIF ì•„ë˜ 1ë¬¸ë‹¨\n\n`;
  
  prompt += `7ï¸âƒ£ CTA ì¡´ì¬:\n`;
  prompt += `   - "ë¬´ë£Œ ë°©ë¬¸ ê²¬ì  ë¬¸ì˜ëŠ”" + "2ë…„ AS" í¬í•¨\n\n`;
  
  prompt += `8ï¸âƒ£ H3 êµ¬ì¡° (ì‚¬ë¡€í˜•ë§Œ):\n`;
  prompt += `   - "### ì„¤ì¹˜ ì „", "### ì‘ì—… ì¤‘", "### ì„¤ì¹˜ í›„"\n`;
  prompt += `   - âŒ "### H3 ì„¤ì¹˜ ì „" ê°™ì€ ì˜ëª»ëœ í˜•ì‹ ê¸ˆì§€!\n\n`;
  
  prompt += `â†’ Level 2 ëˆ„ë½ ë°œê²¬ ì‹œ: ì¶”ê°€ í›„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰\n\n`;
  
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  prompt += `[Level 3] í•µì‹¬ í’ˆì§ˆ í‰ê°€ (6ê°œ) - í’ˆì§ˆ ë³´ì¦! â­â­â­\n`;
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  prompt += `9ï¸âƒ£ í›„í‚¹ ì§ˆë¬¸ í’ˆì§ˆ:\n`;
  prompt += `   [í”„ë¡œì„¸ìŠ¤ ì¤€ìˆ˜]\n`;
  prompt += `   - âœ… ì…ë ¥ ì •ë³´ ë¶„ì„ â†’ ê¸€ì˜ ì£¼ì œ íŒŒì•…\n`;
  prompt += `   - âœ… ì£¼ì œì˜ ë³´í¸ì  ê¶ê¸ˆì¦ 10ê°œ ì´ìƒ ë„ì¶œ\n`;
  prompt += `   - âœ… ê¸€ì—ì„œ ë‹µí•  ìˆ˜ ìˆëŠ” ê²ƒ 3ê°œ ì„ íƒ\n`;
  prompt += `   [ë‹µë³€ ê°€ëŠ¥ì„±]\n`;
  prompt += `   - âœ… ê° ì§ˆë¬¸ì´ ê¸€ì—ì„œ ì‹¤ì œë¡œ ë‹µí•´ì§€ëŠ”ê°€?\n`;
  prompt += `   - âœ… ì–´ëŠ ì„¹ì…˜ì—ì„œ ë‹µí•˜ëŠ”ê°€?\n`;
  prompt += `   [ë³´í¸ì„±]\n`;
  prompt += `   - âœ… íŠ¹ì • ì‚¬ë¡€ê°€ ì•„ë‹Œ, ëŒ€ë¶€ë¶„ì´ ê³µê°í•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ì¸ê°€?\n\n`;
  
  prompt += `ğŸ”Ÿ ë©”ì¸í‚¤ì›Œë“œ "${keyword}" ìì—°ìŠ¤ëŸ¬ì›€:\n`;
  prompt += `   [íšŸìˆ˜ ì ì •ì„±]\n`;
  prompt += `   - âœ… 4~10íšŒ ë²”ìœ„ (ê¶Œì¥ 5~6íšŒ)\n`;
  prompt += `   - âŒ 3íšŒ ì´í•˜: ë¶€ì¡±, 5~6íšŒë¡œ ì¡°ì •\n`;
  prompt += `   - âš ï¸ 11~19íšŒ: ì•½ê°„ ë§ìŒ (í†µê³¼)\n`;
  prompt += `   - âŒ 20íšŒ ì´ìƒ: í‚¤ì›Œë“œ ìŠ¤í„°í•‘ (5~6íšŒë¡œ ì¤„ì´ê¸°)\n`;
  prompt += `   [ìì—°ìŠ¤ëŸ¬ì›€]\n`;
  prompt += `   - âœ… ì–µì§€ìŠ¤ëŸ½ì§€ ì•Šì€ê°€?\n`;
  prompt += `   - âœ… ë¬¸ë§¥ì— ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì•„ ìˆëŠ”ê°€?\n`;
  prompt += `   [ë¶„ì‚° ë°°ì¹˜]\n`;
  prompt += `   - âœ… ì œëª© 1íšŒ, ì„œë¡  1~2íšŒ, ë³¸ë¡  2~3íšŒ, ê²°ë¡  1íšŒ\n\n`;
  
  prompt += `1ï¸âƒ£1ï¸âƒ£ ì‹œê³µ í”„ë¡œì„¸ìŠ¤ ì •í™•ì„±:\n`;
  prompt += `   [ì‹œê³µ ìœ í˜• ëª…í™•ì„±]\n`;
  prompt += `   - âœ… LED ë¦¬í¼/ì „ì²´ êµì²´/ì‹¤ë§íŒ¬ ì„¤ì¹˜ êµ¬ë¶„ ëª…í™•\n`;
  prompt += `   [ì‘ì—… ìˆœì„œ ì •í™•ì„±]\n`;
  prompt += `   - âœ… ì „ì› ì°¨ë‹¨ â†’ í™•ì‚°íŒ ë¶„ë¦¬ â†’ í˜•ê´‘ë“± ì² ê±° â†’ ì•ˆì •ê¸° ì œê±°\n`;
  prompt += `   - âœ… ë°°ì„  ì ê²€ â†’ LED ëª¨ë“ˆ ì¥ì°© â†’ SMPS ì„¤ì¹˜ â†’ ì ë“± í…ŒìŠ¤íŠ¸\n`;
  prompt += `   [ê¸°ìˆ  ìš©ì–´ ì •í™•ì„±]\n`;
  prompt += `   - âœ… LED ëª¨ë“ˆ, LED ì „ìš© ì•ˆì •ê¸°(SMPS), ì¡°ë„(lux) ì •í™• ì‚¬ìš©\n\n`;
  
  prompt += `1ï¸âƒ£2ï¸âƒ£ ê´‘ê³ /ì •ë³´ ê· í˜•:\n`;
  prompt += `   [í™ë³´ ë¹„ìœ¨]\n`;
  prompt += `   - âœ… ì „ì²´ ë¬¸ë‹¨ ì¤‘ í™ë³´ 20% ì´í•˜ (ë ˆí¼ëŸ°ìŠ¤ 2 + CTA 3)\n`;
  prompt += `   - âš ï¸ 21~30%: ì•½ê°„ ë§ìŒ (í†µê³¼)\n`;
  prompt += `   - âŒ 31% ì´ìƒ: ê³¼ë„ (ì¤„ì´ê¸°)\n`;
  prompt += `   [ì‹¤ì§ˆì  ì •ë³´ í’ë¶€ì„±]\n`;
  prompt += `   - âœ… ì†Œë¹„ì „ë ¥ ë¹„êµ, ì¡°ë„ ë³€í™”, ì‘ì—… ê³¼ì •, ê¸°ìˆ  ì„¤ëª…\n`;
  prompt += `   [ìì—°ìŠ¤ëŸ¬ìš´ ë°°ì¹˜]\n`;
  prompt += `   - âœ… "ì €í¬ íœ´ëª…" ê³¼ë„í•œ ë°˜ë³µ ì—†ìŒ\n\n`;
  
  prompt += `1ï¸âƒ£3ï¸âƒ£ í˜„ì¥ê° & ê³µê°:\n`;
  prompt += `   ["ë‚´ ì´ì•¼ê¸°" ëŠë‚Œ]\n`;
  prompt += `   - âœ… ë…ìê°€ ìì‹ ì˜ ìƒí™©ìœ¼ë¡œ ëŠë‚„ ìˆ˜ ìˆëŠ”ê°€?\n`;
  prompt += `   - âœ… ë³´í¸ì  ê³ ë¯¼ì„ ë‹¤ë£¨ëŠ”ê°€?\n`;
  prompt += `   [ìƒìƒí•œ í˜„ì¥ ë¬˜ì‚¬]\n`;
  prompt += `   - âœ… ì‹œê°ì  ì´ë¯¸ì§€ê°€ ë– ì˜¤ë¥´ëŠ”ê°€?\n`;
  prompt += `   - âœ… ì‘ì—… ê³¼ì •ì´ ëˆˆì— ë³´ì´ëŠ”ê°€?\n`;
  prompt += `   [ê³ ê° ê°ì •ì„ ]\n`;
  prompt += `   - âœ… ë¶ˆí¸í•¨ (ë¬¸ì œ) â†’ í•´ê²° (ì‘ì—…) â†’ ë§Œì¡±ê° (ê²°ê³¼)\n\n`;
  
  prompt += `1ï¸âƒ£4ï¸âƒ£ ì§€ì¹¨ ì¤€ìˆ˜ ì¢…í•©:\n`;
  prompt += `   [í•µì‹¬ í’ˆì§ˆ 5ê°€ì§€]\n`;
  prompt += `   - âœ… ìœ„ì˜ 9~13ë²ˆ ëª¨ë‘ ìš°ìˆ˜\n`;
  prompt += `   [ë©”ì¸ ì§€ì¹¨ì„œ ê·œì¹™]\n`;
  prompt += `   - âœ… E-A-T ì›ì¹™ (ì „ë¬¸ì„±, ê¶Œìœ„ì„±, ì‹ ë¢°ì„±)\n`;
  prompt += `   - âœ… ìŠ¤í† ë¦¬í…”ë§ (ë¬¸ì œâ†’í•´ê²°â†’ë³€í™”)\n`;
  prompt += `   - âœ… ë°ì´í„° + ê°ì„± ê· í˜•\n`;
  prompt += `   - âœ… íœ´ë¨¼ë¼ì´í¬ 4ëŒ€ ìš”ì†Œ (êµ¬ì–´ì²´, ì²´ì–¸ ì¢…ê²°, ê°íƒ„ì‚¬, ë¬¸ì¥ ê¸¸ì´)\n`;
  prompt += `   - âœ… ìœ ì‚¬ë¬¸ì„œ ë°©ì§€ (í‘œí˜„ ìˆœí™˜)\n\n`;
  
  prompt += `â†’ Level 3 ë¯¸í¡ ë°œê²¬ ì‹œ: ê°œì„  í›„ ìµœì¢… ì¶œë ¥\n\n`;
  
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  prompt += `âš ï¸âš ï¸âš ï¸ ìµœì¢… í™•ì¸ ë° ì¶œë ¥ í˜•ì‹\n`;
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  prompt += `âœ… Level 1 ì¹˜ëª…ì  í˜•ì‹: ëª¨ë‘ í†µê³¼?\n`;
  prompt += `âœ… Level 2 í•„ìˆ˜ í˜•ì‹: ëª¨ë‘ í¬í•¨?\n`;
  prompt += `âœ… Level 3 í•µì‹¬ í’ˆì§ˆ: ëª¨ë‘ ìš°ìˆ˜?\n\n`;
  
  prompt += `âš ï¸ ë¬¸ì œ ë°œê²¬ ì‹œ ì¦‰ì‹œ ìˆ˜ì •í•˜ì—¬ ìµœì¢… ë²„ì „ ì¶œë ¥!\n`;
  prompt += `âš ï¸ ìˆ˜ì • ì—†ì´ ê·¸ëƒ¥ ì¶œë ¥í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤!\n\n`;
  
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  prompt += `â­â­â­ í•„ìˆ˜ ì¶œë ¥ í˜•ì‹\n`;
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  prompt += `ë°˜ë“œì‹œ ë‹¤ìŒ ìˆœì„œë¡œ ì¶œë ¥í•˜ì„¸ìš”:\n\n`;
  
  prompt += `1ï¸âƒ£ ë¨¼ì € ì™„ì„±ëœ í¬ìŠ¤íŒ… ì „ì²´ë¥¼ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì¶œë ¥\n\n`;
  
  prompt += `2ï¸âƒ£ ê·¸ ë‹¤ìŒ êµ¬ë¶„ì„ ì„ ì¶œë ¥:\n`;
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  prompt += `ğŸ” ìê°€ í‰ê°€ ê²°ê³¼\n`;
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  prompt += `3ï¸âƒ£ ìê°€í‰ê°€ ê²°ê³¼ë¥¼ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥:\n\n`;
  
  prompt += `[Level 1] ì¹˜ëª…ì  í˜•ì‹ ì²´í¬\n`;
  prompt += `[1/8] LED ìˆ˜ëª… ê¸ˆì§€í‘œí˜„ ì²´í¬... âœ… í†µê³¼ (ë˜ëŠ” âŒ ìˆ˜ì •í•¨)\n`;
  prompt += `[2/8] í›„í‚¹ ì§ˆë¬¸ ë¬¼ìŒí‘œ ì²´í¬... âœ… í†µê³¼ (ë˜ëŠ” âŒ ìˆ˜ì •í•¨)\n\n`;
  
  prompt += `[Level 2] í•„ìˆ˜ í˜•ì‹ ì²´í¬\n`;
  prompt += `[3/8] ì‚¬ì§„ ì—…ë¡œë“œ ì²´í¬... âœ… í†µê³¼\n`;
  prompt += `[4/8] ê³ ì • ì´ë¯¸ì§€ 4ì¢… ì²´í¬... âœ… í†µê³¼\n`;
  prompt += `[5/8] LED ìˆ˜ëª… ë°°ì¹˜ 2ê³³ ì²´í¬... âœ… í†µê³¼\n`;
  prompt += `[6/8] íšŒì‚¬ ë ˆí¼ëŸ°ìŠ¤ 2ë¬¸ë‹¨ ì²´í¬... âœ… í†µê³¼\n`;
  prompt += `[7/8] CTA ì¡´ì¬ ì²´í¬... âœ… í†µê³¼\n`;
  prompt += `[8/8] H3 êµ¬ì¡° ì²´í¬... âœ… í†µê³¼\n\n`;
  
  prompt += `[Level 3] í•µì‹¬ í’ˆì§ˆ í‰ê°€\n`;
  prompt += `[1/6] í›„í‚¹ ì§ˆë¬¸ í’ˆì§ˆ í‰ê°€... ìš°ìˆ˜ (ë˜ëŠ” ì–‘í˜¸/ë³´í†µ)\n`;
  prompt += `[2/6] ë©”ì¸í‚¤ì›Œë“œ ìì—°ìŠ¤ëŸ¬ì›€ í‰ê°€... ìš°ìˆ˜ (6íšŒ, ìì—°ìŠ¤ëŸ¬ì›€)\n`;
  prompt += `[3/6] ì‹œê³µ í”„ë¡œì„¸ìŠ¤ ì •í™•ì„± í‰ê°€... ìš°ìˆ˜\n`;
  prompt += `[4/6] ê´‘ê³ /ì •ë³´ ê· í˜• í‰ê°€... ìš°ìˆ˜ (16%)\n`;
  prompt += `[5/6] í˜„ì¥ê° & ê³µê° í‰ê°€... ìš°ìˆ˜\n`;
  prompt += `[6/6] ì§€ì¹¨ ì¤€ìˆ˜ ì¢…í•© í‰ê°€... ìš°ìˆ˜\n\n`;
  
  prompt += `ğŸ’¡ ìµœì¢… í‰ê°€\n`;
  prompt += `ì¢…í•© ì ìˆ˜: XX/100ì \n`;
  prompt += `ê°•ì : (3~5ê°œ í•­ëª©)\n`;
  prompt += `ê°œì„  ì—¬ì§€: (ìˆë‹¤ë©´ 1~2ê°œ í•­ëª©)\n`;
  prompt += `ê²°ë¡ : ì œì¶œ ê°€ëŠ¥í•œ ê³ í’ˆì§ˆ í¬ìŠ¤íŒ…ì…ë‹ˆë‹¤. (ë˜ëŠ” ê°œì„  ê¶Œì¥)\n\n`;
  
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  prompt += `âš ï¸âš âš ï¸ ì¤‘ìš”:\n`;
  prompt += `- í¬ìŠ¤íŒ… ë³¸ë¬¸ê³¼ í‰ê°€ ê²°ê³¼ ì‚¬ì´ì— ë°˜ë“œì‹œ êµ¬ë¶„ì„ ì„ ë„£ìœ¼ì„¸ìš”!\n`;
  prompt += `- í‰ê°€ ê²°ê³¼ëŠ” ìƒì„¸í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš” (ë‹¨ìˆœ âœ…ë§Œ ë‚˜ì—´ X)\n`;
  prompt += `- Level 3ëŠ” ê° í•­ëª©ë§ˆë‹¤ ê°„ë‹¨í•œ ê·¼ê±° ì„¤ëª… í¬í•¨\n\n`;
  
  prompt += `ì§€ê¸ˆ ë°”ë¡œ ì‘ì„±ì„ ì‹œì‘í•˜ì„¸ìš”!`;
  
  return prompt;
}

function createContentArray(textPrompt, images) {
  const contentArray = [];
  
  contentArray.push({
    type: "text",
    text: textPrompt
  });
  
  if (images && images.length > 0) {
    console.log(`\nğŸ–¼ï¸ ì´ë¯¸ì§€ë¥¼ Claudeì— ì „ì†¡í•©ë‹ˆë‹¤: ${images.length}ì¥`);
    
    images.forEach((img, idx) => {
      contentArray.push({
        type: "image",
        source: {
          type: "base64",
          media_type: img.mimeType,
          data: img.data
        }
      });
      console.log(`   ${idx + 1}. ${img.name} (${img.mimeType})`);
    });
  } else {
    console.log(`\nğŸ“ ì´ë¯¸ì§€ ì—†ì´ í…ìŠ¤íŠ¸ë§Œ ì „ì†¡í•©ë‹ˆë‹¤.`);
  }
  
  return contentArray;
}

function parseResponse(content) {
  // ìê°€í‰ê°€ êµ¬ë¶„ì„ ìœ¼ë¡œ ë¶„ë¦¬
  const evalMarker = 'ğŸ” ìê°€ í‰ê°€ ê²°ê³¼';
  
  if (content.includes(evalMarker)) {
    const parts = content.split(evalMarker);
    
    return {
      markdown: parts[0].trim().replace(/â”+/g, '').trim(),  // êµ¬ë¶„ì„  ì œê±°
      evaluation: evalMarker + parts[1].trim()  // í‰ê°€ ê²°ê³¼ (êµ¬ë¶„ì„  í¬í•¨)
    };
  }
  
  // í‰ê°€ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš° (êµ¬ë¶„ì„ ì´ ì—†ìœ¼ë©´)
  return {
    markdown: content.trim(),
    evaluation: null
  };
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ” ìë™ ê²€ì¦ & ì¬ì‘ì„± ì‹œìŠ¤í…œ v4.5
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

function fullValidation(markdown, keyword, data) {
  const issues = [];
  
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // [Level 1] ì¹˜ëª…ì  í˜•ì‹ (2ê°œ)
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  
  // 1. LED ìˆ˜ëª… ê¸ˆì§€í‘œí˜„
  const prohibited = ['10ë…„', 'ë°˜ì˜êµ¬', '50,000ì‹œê°„', '50000ì‹œê°„', 'í‰ìƒ', 'ë¬´ê±±ì •'];
  const foundProhibited = prohibited.filter(term => markdown.includes(term));
  if (foundProhibited.length > 0) {
    issues.push({
      level: 1,
      category: 'LED ìˆ˜ëª… ê¸ˆì§€í‘œí˜„',
      problem: `ê¸ˆì§€ í‘œí˜„ ë°œê²¬: ${foundProhibited.join(', ')}`,
      solution: 'ëª¨ë‘ ì‚­ì œí•˜ê³  "2ë…„ AS ë³´ì¦"ìœ¼ë¡œ êµì²´'
    });
  }
  
  // 2. í›„í‚¹ ì§ˆë¬¸ ë¬¼ìŒí‘œ
  const h2Lines = markdown.match(/^## .+$/gm) || [];
  const questionMarks = h2Lines.filter(line => line.includes('?'));
  if (questionMarks.length < 3) {
    issues.push({
      level: 1,
      category: 'í›„í‚¹ ì§ˆë¬¸',
      problem: `ë¬¼ìŒí‘œë¡œ ëë‚˜ëŠ” ì§ˆë¬¸ì´ ${questionMarks.length}ê°œ (3ê°œ í•„ìš”)`,
      solution: 'H2 ì œëª© 3ê°œë¥¼ ëª¨ë‘ "?"ë¡œ ëë‚˜ëŠ” ì§ˆë¬¸í˜•ìœ¼ë¡œ ë³€ê²½'
    });
  }
  
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // [Level 2] í•„ìˆ˜ í˜•ì‹ (ì£¼ìš” í•­ëª©ë§Œ)
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  
  // 3. ê³ ì • ì´ë¯¸ì§€
  const hasCompanyGif = markdown.includes('[GIF: ì—…ì²´ì†Œê°œ.gif]');
  const hasThumbnail = markdown.includes('[ì¸ë„¤ì¼: ëŒ€í‘œì´ë¯¸ì§€.jpg]');
  if (!hasCompanyGif || !hasThumbnail) {
    const missing = [];
    if (!hasCompanyGif) missing.push('ì—…ì²´ì†Œê°œ.gif');
    if (!hasThumbnail) missing.push('ëŒ€í‘œì´ë¯¸ì§€.jpg');
    issues.push({
      level: 2,
      category: 'ê³ ì • ì´ë¯¸ì§€ ëˆ„ë½',
      problem: `ëˆ„ë½: ${missing.join(', ')}`,
      solution: 'íšŒì‚¬ ë ˆí¼ëŸ°ìŠ¤ ì„¹ì…˜ì— [GIF: ì—…ì²´ì†Œê°œ.gif]ì™€ [ì¸ë„¤ì¼: ëŒ€í‘œì´ë¯¸ì§€.jpg] ì¶”ê°€'
    });
  }
  
  // 4. LED ìˆ˜ëª… ë°°ì¹˜
  const asCount = (markdown.match(/2ë…„\s*AS|2ë…„\s*ë¬´ìƒ\s*AS/g) || []).length;
  if (asCount < 2) {
    issues.push({
      level: 2,
      category: 'LED ìˆ˜ëª… ë°°ì¹˜',
      problem: `"2ë…„ AS" ì–¸ê¸‰ ${asCount}íšŒ (2íšŒ í•„ìš”)`,
      solution: 'ì†Œë¹„ì „ë ¥ í‘œ ë‹¤ìŒê³¼ CTA ë¶€ë¶„ì— ê° 1íšŒì”© ë°°ì¹˜'
    });
  }
  
  // 5. H3 êµ¬ì¡° (ì‚¬ë¡€í˜•ë§Œ)
  if (data.postingType === 'ì‚¬ë¡€í˜•') {
    const hasWrongH3 = markdown.includes('### H3 ');
    if (hasWrongH3) {
      issues.push({
        level: 2,
        category: 'H3 í˜•ì‹ ì˜¤ë¥˜',
        problem: '"H3" í…ìŠ¤íŠ¸ê°€ ì œëª©ì— í¬í•¨ë¨',
        solution: '"### H3 ì„¤ì¹˜ ì „" â†’ "### ì„¤ì¹˜ ì „"ìœ¼ë¡œ ìˆ˜ì • (ëª¨ë“  H3 ì œëª©)'
      });
    }
  }
  
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // [Level 3] í•µì‹¬ í’ˆì§ˆ (ì£¼ìš” í•­ëª©ë§Œ)
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  
  // 6. ë©”ì¸í‚¤ì›Œë“œ ìì—°ìŠ¤ëŸ¬ì›€
  const keywordMatches = markdown.match(new RegExp(keyword, 'g')) || [];
  const keywordCount = keywordMatches.length;
  
  if (keywordCount < 4) {
    issues.push({
      level: 3,
      category: 'ë©”ì¸í‚¤ì›Œë“œ ë¶€ì¡±',
      problem: `"${keyword}" íšŸìˆ˜: ${keywordCount}íšŒ (ìµœì†Œ 4íšŒ, ê¶Œì¥ 5~6íšŒ)`,
      solution: 'ì œëª©, ì„œë¡ , ë³¸ë¡ , ê²°ë¡ ì— ìì—°ìŠ¤ëŸ½ê²Œ ë¶„ì‚° ë°°ì¹˜í•˜ì—¬ 5~6íšŒë¡œ ì¡°ì •'
    });
  } else if (keywordCount > 10) {
    issues.push({
      level: 3,
      category: 'ë©”ì¸í‚¤ì›Œë“œ ê³¼ë‹¤',
      problem: `"${keyword}" íšŸìˆ˜: ${keywordCount}íšŒ (ê¶Œì¥ 5~6íšŒ)`,
      solution: 'ì–µì§€ë¡œ ë°˜ë³µëœ ë¶€ë¶„ì„ ì œê±°í•˜ì—¬ 5~6íšŒë¡œ ì¤„ì´ê¸°'
    });
  }
  
  // 7. ê´‘ê³ /ì •ë³´ ê· í˜•
  const companyMentions = (markdown.match(/ì €í¬|íœ´ëª…|ë‹¹ì‚¬/g) || []).length;
  const totalLines = markdown.split('\n').filter(line => line.trim().length > 0).length;
  const adRatio = (companyMentions / totalLines) * 100;
  
  if (adRatio > 15) {
    issues.push({
      level: 3,
      category: 'ê´‘ê³ /ì •ë³´ ê· í˜•',
      problem: `í™ë³´ ì–¸ê¸‰ ë¹„ìœ¨ ê³¼ë‹¤ (ì•½ ${Math.round(adRatio)}%, ê¶Œì¥ 10% ì´í•˜)`,
      solution: 'íšŒì‚¬ í™ë³´ ë¬¸êµ¬ë¥¼ ì¤„ì´ê³  ì‹¤ì§ˆì  ì •ë³´(ì†Œë¹„ì „ë ¥, ì¡°ë„, ì‘ì—… ê³¼ì •) ë¹„ì¤‘ ì¦ê°€'
    });
  }
  
  return issues;
}

function createDetailedFeedback(issues, keyword) {
  let feedback = `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  feedback += `ğŸ” ìê°€í‰ê°€ ê²°ê³¼ - ìˆ˜ì • í•„ìš” ì‚¬í•­\n`;
  feedback += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  // Levelë³„ë¡œ ê·¸ë£¹í™”
  const level1 = issues.filter(i => i.level === 1);
  const level2 = issues.filter(i => i.level === 2);
  const level3 = issues.filter(i => i.level === 3);
  
  if (level1.length > 0) {
    feedback += `[Level 1] ì¹˜ëª…ì  í˜•ì‹ (${level1.length}ê°œ) âš ï¸\n\n`;
    level1.forEach((issue, idx) => {
      feedback += `${idx + 1}. ${issue.category}\n`;
      feedback += `   ë¬¸ì œ: ${issue.problem}\n`;
      feedback += `   í•´ê²°: ${issue.solution}\n\n`;
    });
  }
  
  if (level2.length > 0) {
    feedback += `[Level 2] í•„ìˆ˜ í˜•ì‹ (${level2.length}ê°œ)\n\n`;
    level2.forEach((issue, idx) => {
      feedback += `${idx + 1}. ${issue.category}\n`;
      feedback += `   ë¬¸ì œ: ${issue.problem}\n`;
      feedback += `   í•´ê²°: ${issue.solution}\n\n`;
    });
  }
  
  if (level3.length > 0) {
    feedback += `[Level 3] í•µì‹¬ í’ˆì§ˆ (${level3.length}ê°œ)\n\n`;
    level3.forEach((issue, idx) => {
      feedback += `${idx + 1}. ${issue.category}\n`;
      feedback += `   ë¬¸ì œ: ${issue.problem}\n`;
      feedback += `   í•´ê²°: ${issue.solution}\n\n`;
    });
  }
  
  feedback += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  feedback += `âœï¸ ìˆ˜ì • ì§€ì‹œ:\n`;
  feedback += `ìœ„ì˜ ëª¨ë“  ë¬¸ì œë¥¼ ìˆ˜ì •í•œ ì™„ì „í•œ í¬ìŠ¤íŒ…ì„ ë‹¤ì‹œ ì‘ì„±í•˜ì„¸ìš”.\n`;
  feedback += `ìˆ˜ì • ì‚¬í•­ ì„¤ëª…ì€ ì¶œë ¥í•˜ì§€ ë§ê³ , ìˆ˜ì •ëœ ìµœì¢… í¬ìŠ¤íŒ…ë§Œ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì¶œë ¥í•˜ì„¸ìš”.\n`;
  
  return feedback;
}

async function regenerateWithFeedback(originalMarkdown, feedback, keyword) {
  const prompt = `ë‹¤ìŒì€ ìƒì„±ëœ ë„¤ì´ë²„ ë¸”ë¡œê·¸ í¬ìŠ¤íŒ…ì…ë‹ˆë‹¤:

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ ì›ë³¸ í¬ìŠ¤íŒ…
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${originalMarkdown}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${feedback}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸ ì¤‘ìš”:
- ìœ„ì˜ ëª¨ë“  ë¬¸ì œë¥¼ ìˆ˜ì •í•œ ì™„ì „í•œ í¬ìŠ¤íŒ…ì„ ë‹¤ì‹œ ì‘ì„±í•˜ì„¸ìš”
- ìˆ˜ì • ì‚¬í•­ ì„¤ëª…ì€ í•˜ì§€ ë§ˆì„¸ìš”
- ìˆ˜ì •ëœ ìµœì¢… í¬ìŠ¤íŒ…ë§Œ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•˜ì„¸ìš”
- ì›ë³¸ì˜ ì¢‹ì€ ë¶€ë¶„ì€ ìœ ì§€í•˜ê³  ë¬¸ì œ ë¶€ë¶„ë§Œ ìˆ˜ì •í•˜ì„¸ìš”

ì§€ê¸ˆ ë°”ë¡œ ìˆ˜ì •ëœ í¬ìŠ¤íŒ…ì„ ì¶œë ¥í•˜ì„¸ìš”:`;

  const message = await anthropic.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 8000,
    messages: [
      {
        role: 'user',
        content: prompt
      }
    ]
  });
  
  return message.content[0].text.trim();
}

async function generateWithAutoRevision(data, images) {
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // 1ï¸âƒ£ ì²« ë²ˆì§¸ ìƒì„±
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  console.log('ğŸš€ 1ì°¨ í¬ìŠ¤íŒ… ìƒì„± ì¤‘...\n');
  
  const textPrompt = createTextPrompt(data, images);
  const contentArray = createContentArray(textPrompt, images);
  
  const message1 = await anthropic.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 8000,
    messages: [{ role: 'user', content: contentArray }]
  });
  
  const fullContent1 = message1.content[0].text.trim();
  const parsed1 = parseResponse(fullContent1);
  
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // 2ï¸âƒ£ ì™„ì „í•œ ê²€ì¦ (Level 1~3)
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ğŸ” ìë™ ê²€ì¦ ì‹œìŠ¤í…œ ì‹¤í–‰ ì¤‘...');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
  
  const issues = fullValidation(parsed1.markdown, data.keyword, data);
  
  if (issues.length === 0) {
    console.log('âœ… ê²€ì¦ í†µê³¼! ëª¨ë“  ê¸°ì¤€ ì¶©ì¡±!');
    console.log('   - Level 1: í†µê³¼ âœ…');
    console.log('   - Level 2: í†µê³¼ âœ…');
    console.log('   - Level 3: í†µê³¼ âœ…\n');
    
    return {
      success: true,
      markdown: parsed1.markdown,
      evaluation: parsed1.evaluation,  // â­ í‰ê°€ ê²°ê³¼ ì¶”ê°€
      attempts: 1,
      issues: []
    };
  }
  
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // 3ï¸âƒ£ ë¬¸ì œ ë°œê²¬ â†’ 1íšŒ ì¬ì‘ì„±
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  console.log(`âš ï¸ ${issues.length}ê°œ ë¬¸ì œ ë°œê²¬:`);
  issues.forEach(issue => {
    console.log(`   [Level ${issue.level}] ${issue.category}: ${issue.problem}`);
  });
  
  console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ğŸ”„ ìë™ ìˆ˜ì • ì¤‘... (1íšŒë§Œ)');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
  
  const feedback = createDetailedFeedback(issues, data.keyword);
  const fullContent2 = await regenerateWithFeedback(parsed1.markdown, feedback, data.keyword);
  const parsed2 = parseResponse(fullContent2);
  
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // 4ï¸âƒ£ 2ì°¨ ê²€ì¦ (ì°¸ê³ ìš©)
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  const issues2 = fullValidation(parsed2.markdown, data.keyword, data);
  
  if (issues2.length === 0) {
    console.log('âœ… 2ì°¨ ê²€ì¦ í†µê³¼! ëª¨ë“  ë¬¸ì œ í•´ê²°!');
    console.log('   - Level 1: í†µê³¼ âœ…');
    console.log('   - Level 2: í†µê³¼ âœ…');
    console.log('   - Level 3: í†µê³¼ âœ…\n');
  } else {
    console.log(`â„¹ï¸ 2ì°¨ ê²€ì¦: ${issues2.length}ê°œ í•­ëª© ë‚¨ìŒ (ì‚¬ìš©ì ìˆ˜ë™ ìˆ˜ì • ê°€ëŠ¥)`);
    issues2.forEach(issue => {
      console.log(`   [Level ${issue.level}] ${issue.category}`);
    });
    console.log();
  }
  
  return {
    success: true,
    markdown: parsed2.markdown,
    evaluation: parsed2.evaluation,  // â­ í‰ê°€ ê²°ê³¼ ì¶”ê°€
    attempts: 2,
    issues: issues2
  };
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ›£ï¸ API ë¼ìš°íŠ¸
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

app.get('/api/health', (req, res) => {
  res.json({ 
    status: 'ok',
    message: 'ì„œë²„ ì •ìƒ ì‘ë™ ì¤‘',
    version: 'v4.6.1 (ì´ë¯¸ì§€ ë¶„ì„ ê°•í™”!)',
    guidelines: {
      main_guideline: guidelineManager.guidelines.mainGuideline ? 'LOADED â­â­â­' : 'MISSING âŒ',
      loaded: Object.keys(guidelineManager.guidelines).length,
      total_size: `${Math.round(Object.values(guidelineManager.guidelines).join('').length / 1024)}KB`
    },
    features: [
      'â­â­â­ NEW: ì´ë¯¸ì§€ ë¶„ì„ ëª…ì‹œì  ê°•í™”! (í˜„ì¥ê° UP!)',
      'â­â­â­ NEW: Before/After ë¹„êµ ì‹œê°í™”!',
      'â­â­â­ NEW: ë…ìê°€ í˜„ì¥ì— ìˆëŠ” ë“¯í•œ ìƒìƒí•œ ë¬˜ì‚¬!',
      'âœ… Claude ìê°€í‰ê°€ (14ê°œ í•­ëª©)',
      'âœ… ì„œë²„ ë ˆë²¨ ìë™ ê²€ì¦ (ì´ì¤‘ ì•ˆì „ì¥ì¹˜)',
      'âœ… êµ¬ì²´ì  í”¼ë“œë°± ê¸°ë°˜ ìë™ ì¬ì‘ì„±',
      'âœ… í‰ê°€ ê²°ê³¼ë¥¼ í”„ë¡ íŠ¸ì—”ë“œì— í‘œì‹œ',
      'âœ… ë©”ì¸ ì§€ì¹¨ì„œ v8.2 ìµœìš°ì„  ë¡œë“œ',
      'âœ… ìê°€í‰ê°€ ì‹œìŠ¤í…œ v2.0 ì™„ì „ í†µí•©',
      'âš¡ ìµœëŒ€ ì‹œê°„: 60ì´ˆ (1ì°¨ 30ì´ˆ + ì¬ì‘ì„± 30ì´ˆ)',
      'ğŸ¯ í€„ë¦¬í‹° ëª©í‘œ: 98%+ (ì´ë¯¸ì§€ ë¶„ì„ + ìê°€í‰ê°€ + ì„œë²„ ê²€ì¦!)',
      'â­ guidelines í´ë” 11ê°œ íŒŒì¼ ë™ì  ë¡œë“œ',
      'â­ ìƒí™©ë³„ í•„ìš”í•œ ê°€ì´ë“œë§Œ ì„ íƒ',
      'â­ ë””ë°ìŠ¤ìœ„ì¹˜ ì•„íŒŒíŠ¸ ìë™ ê°ì§€',
      'HTMLì€ ë‹¤ìš´ë¡œë“œ ì‹œ ì¦‰ì‹œ ë³€í™˜',
      'ì´ë¯¸ì§€ Claude ì „ì†¡ + ë¶„ì„ âœ…',
      'í•œê¸€ íŒŒì¼ëª… ì§€ì› âœ…',
      'Claude ëŒ€í™”ë¡œ í¬ìŠ¤íŒ… ìˆ˜ì • âœ…',
      'ìŠ¤íŠ¸ë¦¬ë° ì‹¤ì‹œê°„ ì‘ë‹µ âœ…'
    ]
  });
});

app.post('/api/generate', upload.array('images'), async (req, res) => {
  try {
    console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('ğŸ“¨ í¬ìŠ¤íŒ… ìƒì„± ìš”ì²­ (v4.5)');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    
    const data = parseInputData(req);
    console.log('âœ… ë°ì´í„° íŒŒì‹± ì™„ë£Œ');
    console.log(`   - í‚¤ì›Œë“œ: ${data.keyword}`);
    console.log(`   - íƒ€ì…: ${data.postingType}`);
    console.log(`   - ë‹¨ì§€ëª…: ${data.complexName || 'ì—†ìŒ'}`);
    console.log(`   - ê³µê°„ ìˆ˜: ${data.spaceData ? data.spaceData.length : 0}ê°œ`);
    
    console.log(`\nğŸ“ ì—…ë¡œë“œëœ íŒŒì¼: ${req.files ? req.files.length : 0}ê°œ`);
    if (req.files && req.files.length > 0) {
      req.files.forEach((file, idx) => {
        console.log(`   ${idx + 1}. ${file.originalname} (${Math.round(file.size / 1024)}KB)`);
      });
    }
    const images = processImages(req.files);
    console.log(`âœ… ì´ë¯¸ì§€ ì²˜ë¦¬ ì™„ë£Œ: ${images.length}ê°œ\n`);
    
    // â­â­â­ ìë™ ê²€ì¦ & 1íšŒ ì¬ì‘ì„± ì‹œìŠ¤í…œ
    const result = await generateWithAutoRevision(data, images);
    
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('âœ… í¬ìŠ¤íŒ… ìƒì„± ì™„ë£Œ (v4.5)');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log(`   - ì‹œë„ íšŸìˆ˜: ${result.attempts}íšŒ`);
    console.log(`   - ë§ˆí¬ë‹¤ìš´: ${result.markdown.length}ì`);
    console.log(`   - í‚¤ì›Œë“œ íšŸìˆ˜: ${(result.markdown.match(new RegExp(data.keyword, 'g')) || []).length}íšŒ`);
    console.log(`   - ë‚¨ì€ ë¬¸ì œ: ${result.issues.length}ê°œ`);
    console.log(`   - ìë™ ê²€ì¦: ì™„ë£Œ â­`);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    
    res.json({
      success: true,
      content: result.markdown,
      attempts: result.attempts,
      remainingIssues: result.issues,
      stats: {
        length: result.markdown.length,
        keywordCount: (result.markdown.match(new RegExp(data.keyword, 'g')) || []).length,
        imageCount: images.length
      }
    });
    
  } catch (error) {
    console.error('\nâŒ ì—ëŸ¬ ë°œìƒ:', error.message);
    console.error(error.stack);
    
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// âš¡ í¬ìŠ¤íŒ… ìƒì„± API (ìŠ¤íŠ¸ë¦¬ë° - ì§„í–‰ ìƒí™© ì‹¤ì‹œê°„ í‘œì‹œ)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

app.post('/api/generate-stream', upload.array('images'), async (req, res) => {
  try {
    console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('âš¡ í¬ìŠ¤íŒ… ìƒì„± ìš”ì²­ (ìŠ¤íŠ¸ë¦¬ë°)');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    
    // SSE í—¤ë” ì„¤ì •
    res.setHeader('Content-Type', 'text/event-stream');
    res.setHeader('Cache-Control', 'no-cache');
    res.setHeader('Connection', 'keep-alive');
    
    const sendProgress = (message, step) => {
      res.write(`data: ${JSON.stringify({ type: 'progress', message, step })}\n\n`);
    };
    
    // 1ï¸âƒ£ ë°ì´í„° íŒŒì‹±
    sendProgress('ğŸ“‹ ë°ì´í„° íŒŒì‹± ì¤‘...', 1);
    const data = parseInputData(req);
    console.log('âœ… ë°ì´í„° íŒŒì‹± ì™„ë£Œ');
    
    // 2ï¸âƒ£ ì´ë¯¸ì§€ ì²˜ë¦¬
    sendProgress(`ğŸ–¼ï¸ ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘... (${req.files ? req.files.length : 0}ì¥)`, 2);
    const images = processImages(req.files);
    console.log(`âœ… ì´ë¯¸ì§€ ì²˜ë¦¬ ì™„ë£Œ: ${images.length}ê°œ`);
    
    // 3ï¸âƒ£ ê°€ì´ë“œë¼ì¸ ì„ íƒ
    sendProgress('ğŸ“š ê°€ì´ë“œë¼ì¸ ì„ íƒ ì¤‘...', 3);
    const selectedGuidelines = guidelineManager.selectRelevantGuidelines(data);
    console.log(`âœ… ì„ íƒëœ ê°€ì´ë“œ: ${selectedGuidelines.length}ê°œ`);
    
    // 4ï¸âƒ£ í”„ë¡¬í”„íŠ¸ ì‘ì„±
    sendProgress('ğŸ“ í”„ë¡¬í”„íŠ¸ ì‘ì„± ì¤‘...', 4);
    const textPrompt = createTextPrompt(data, images);
    const contentArray = createContentArray(textPrompt, images);
    console.log(`âœ… í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ`);
    
    // 5ï¸âƒ£ 1ì°¨ ìƒì„±
    sendProgress('ğŸ¤– Claudeì—ê²Œ 1ì°¨ ìš”ì²­ ì¤‘...', 5);
    sendProgress('âœï¸ í¬ìŠ¤íŒ… ì‘ì„± ì¤‘... (30ì´ˆ ì˜ˆìƒ)', 6);
    
    const message1 = await anthropic.messages.create({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 8000,
      messages: [{ role: 'user', content: contentArray }]
    });
    
    const fullContent1 = message1.content[0].text.trim();
    const parsed1 = parseResponse(fullContent1);  // â­ í‰ê°€ ê²°ê³¼ ë¶„ë¦¬
    console.log('âœ… 1ì°¨ ìƒì„± ì™„ë£Œ');
    
    // 6ï¸âƒ£ ê²€ì¦
    sendProgress('ğŸ” ìë™ ê²€ì¦ ì¤‘... (Level 1~3)', 7);
    const issues = fullValidation(parsed1.markdown, data.keyword, data);
    
    if (issues.length === 0) {
      // âœ… í†µê³¼!
      sendProgress('âœ… ê²€ì¦ í†µê³¼! ëª¨ë“  ê¸°ì¤€ ì¶©ì¡±!', 8);
      console.log('âœ… ê²€ì¦ í†µê³¼!');
      
      res.write(`data: ${JSON.stringify({ 
        type: 'done',
        success: true,
        content: parsed1.markdown,
        evaluation: parsed1.evaluation,  // â­ í‰ê°€ ê²°ê³¼ ì¶”ê°€
        attempts: 1,
        remainingIssues: [],
        stats: {
          length: parsed1.markdown.length,
          keywordCount: (parsed1.markdown.match(new RegExp(data.keyword, 'g')) || []).length,
          imageCount: images.length
        }
      })}\n\n`);
      
      res.end();
      return;
    }
    
    // 7ï¸âƒ£ ë¬¸ì œ ë°œê²¬
    sendProgress(`âš ï¸ ${issues.length}ê°œ ë¬¸ì œ ë°œê²¬ - ìë™ ìˆ˜ì • ì‹œì‘`, 8);
    console.log(`âš ï¸ ${issues.length}ê°œ ë¬¸ì œ ë°œê²¬`);
    issues.forEach(issue => {
      sendProgress(`   â€¢ [Level ${issue.level}] ${issue.category}`, 8);
      console.log(`   [Level ${issue.level}] ${issue.category}: ${issue.problem}`);
    });
    
    // 8ï¸âƒ£ ì¬ì‘ì„±
    sendProgress('ğŸ”„ ìˆ˜ì • ìš”ì²­ ìƒì„± ì¤‘...', 9);
    const feedback = createDetailedFeedback(issues, data.keyword);
    
    sendProgress('ğŸ¤– Claudeì—ê²Œ 2ì°¨ ìš”ì²­ ì¤‘...', 10);
    sendProgress('âœï¸ ì¬ì‘ì„± ì¤‘... (30ì´ˆ ì˜ˆìƒ)', 11);
    
    const fullContent2 = await regenerateWithFeedback(parsed1.markdown, feedback, data.keyword);
    const parsed2 = parseResponse(fullContent2);  // â­ í‰ê°€ ê²°ê³¼ ë¶„ë¦¬
    console.log('âœ… 2ì°¨ ìƒì„± ì™„ë£Œ');
    
    // 9ï¸âƒ£ 2ì°¨ ê²€ì¦
    sendProgress('ğŸ” 2ì°¨ ê²€ì¦ ì¤‘...', 12);
    const issues2 = fullValidation(parsed2.markdown, data.keyword, data);
    
    if (issues2.length === 0) {
      sendProgress('âœ… 2ì°¨ ê²€ì¦ í†µê³¼! ëª¨ë“  ë¬¸ì œ í•´ê²°!', 13);
      console.log('âœ… 2ì°¨ ê²€ì¦ í†µê³¼!');
    } else {
      sendProgress(`â„¹ï¸ ${issues2.length}ê°œ í•­ëª© ë‚¨ìŒ (ì‚¬ìš©ì ìˆ˜ë™ ìˆ˜ì • ê°€ëŠ¥)`, 13);
      console.log(`â„¹ï¸ ${issues2.length}ê°œ í•­ëª© ë‚¨ìŒ`);
    }
    
    // ğŸ”Ÿ ì™„ë£Œ
    sendProgress('âœ… ì™„ë£Œ!', 14);
    
    res.write(`data: ${JSON.stringify({ 
      type: 'done',
      success: true,
      content: parsed2.markdown,
      evaluation: parsed2.evaluation,  // â­ í‰ê°€ ê²°ê³¼ ì¶”ê°€
      attempts: 2,
      remainingIssues: issues2,
      stats: {
        length: parsed2.markdown.length,
        keywordCount: (parsed2.markdown.match(new RegExp(data.keyword, 'g')) || []).length,
        imageCount: images.length
      }
    })}\n\n`);
    
    res.end();
    
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('âœ… ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    
  } catch (error) {
    console.error('\nâŒ ì—ëŸ¬ ë°œìƒ:', error.message);
    res.write(`data: ${JSON.stringify({ type: 'error', message: error.message })}\n\n`);
    res.end();
  }
});

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ’¬ í¬ìŠ¤íŒ… ìˆ˜ì • API (Claude ëŒ€í™”)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

app.post('/api/revise', async (req, res) => {
  try {
    console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('ğŸ’¬ í¬ìŠ¤íŒ… ìˆ˜ì • ìš”ì²­');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    
    const { currentContent, revisionRequest, chatHistory, originalData } = req.body;
    
    console.log(`ğŸ“ í˜„ì¬ í¬ìŠ¤íŒ… ê¸¸ì´: ${currentContent.length}ì`);
    console.log(`ğŸ’¬ ìˆ˜ì • ìš”ì²­: ${revisionRequest}`);
    console.log(`ğŸ“Š ëŒ€í™” íˆìŠ¤í† ë¦¬: ${chatHistory ? chatHistory.length : 0}ê°œ`);
    
    let prompt = `ë‹¹ì‹ ì€ ë„¤ì´ë²„ ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ìˆ˜ì • ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n\n`;
    
    prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    prompt += `ğŸ“‹ í˜„ì¬ í¬ìŠ¤íŒ…\n`;
    prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    prompt += `${currentContent}\n\n`;
    
    if (originalData) {
      prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
      prompt += `ğŸ“Š ì›ë³¸ ë°ì´í„° (ì°¸ê³ ìš©)\n`;
      prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
      prompt += `í‚¤ì›Œë“œ: ${originalData.keyword}\n`;
      prompt += `ë‹¨ì§€ëª…: ${originalData.complexName}\n`;
      if (originalData.specialNote) {
        prompt += `íŠ¹ì´ì‚¬í•­: ${originalData.specialNote}\n`;
      }
      prompt += `\n`;
    }
    
    if (chatHistory && chatHistory.length > 0) {
      prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
      prompt += `ğŸ’¬ ì´ì „ ëŒ€í™” ë‚´ì—­\n`;
      prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
      chatHistory.forEach((chat, idx) => {
        if (chat.role === 'user') {
          prompt += `ì‚¬ìš©ì: ${chat.content}\n`;
        } else if (chat.role === 'assistant') {
          prompt += `Claude: ${chat.content}\n`;
        }
      });
      prompt += `\n`;
    }
    
    prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    prompt += `âœï¸ ìˆ˜ì • ìš”ì²­\n`;
    prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    prompt += `${revisionRequest}\n\n`;
    
    prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    prompt += `ğŸ“ ì‘ë‹µ í˜•ì‹\n`;
    prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    
    prompt += `ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:\n\n`;
    prompt += `<ì„¤ëª…>\n`;
    prompt += `ìˆ˜ì • ë‚´ìš©ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª… (2-3ë¬¸ì¥)\n`;
    prompt += `</ì„¤ëª…>\n\n`;
    prompt += `<ìˆ˜ì •ëœí¬ìŠ¤íŒ…>\n`;
    prompt += `ì „ì²´ í¬ìŠ¤íŒ… ë§ˆí¬ë‹¤ìš´ (ì™„ì „í•œ í˜•íƒœë¡œ)\n`;
    prompt += `</ìˆ˜ì •ëœí¬ìŠ¤íŒ…>\n\n`;
    
    prompt += `âš ï¸ ì£¼ì˜ì‚¬í•­:\n`;
    prompt += `- <ì„¤ëª…> íƒœê·¸ ì•ˆì—ëŠ” ìˆ˜ì • ë‚´ìš© ì„¤ëª…ë§Œ ì‘ì„±\n`;
    prompt += `- <ìˆ˜ì •ëœí¬ìŠ¤íŒ…> íƒœê·¸ ì•ˆì—ëŠ” ì™„ì „í•œ ë§ˆí¬ë‹¤ìš´ í¬ìŠ¤íŒ… ì „ì²´ë¥¼ ì‘ì„±\n`;
    prompt += `- ìš”ì²­ëœ ë¶€ë¶„ë§Œ ìˆ˜ì •í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€\n`;
    prompt += `- ë§ˆí¬ë‹¤ìš´ í˜•ì‹ ìœ ì§€ (## ì œëª©, ### ì†Œì œëª© ë“±)\n`;
    prompt += `- ì´ë¯¸ì§€ íƒœê·¸ [ì´ë¯¸ì§€: íŒŒì¼ëª….jpg] í˜•ì‹ ìœ ì§€\n`;
    
    console.log(`\nğŸ¤– Claude API í˜¸ì¶œ ì¤‘...\n`);
    
    const message = await anthropic.messages.create({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 8000,
      messages: [
        {
          role: 'user',
          content: prompt
        }
      ]
    });
    
    const fullResponse = message.content[0].text;
    
    const explanationMatch = fullResponse.match(/<ì„¤ëª…>([\s\S]*?)<\/ì„¤ëª…>/);
    const revisedMatch = fullResponse.match(/<ìˆ˜ì •ëœí¬ìŠ¤íŒ…>([\s\S]*?)<\/ìˆ˜ì •ëœí¬ìŠ¤íŒ…>/);
    
    const explanation = explanationMatch ? explanationMatch[1].trim() : 'í¬ìŠ¤íŒ…ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.';
    const revisedContent = revisedMatch ? revisedMatch[1].trim() : fullResponse;
    
    console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('âœ… í¬ìŠ¤íŒ… ìˆ˜ì • ì™„ë£Œ');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log(`   - ì„¤ëª… ê¸¸ì´: ${explanation.length}ì`);
    console.log(`   - ìˆ˜ì • í¬ìŠ¤íŒ… ê¸¸ì´: ${revisedContent.length}ì`);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    
    res.json({
      success: true,
      explanation,
      revisedContent
    });
    
  } catch (error) {
    console.error('\nâŒ ì—ëŸ¬ ë°œìƒ:', error.message);
    console.error(error.stack);
    
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// âš¡ í¬ìŠ¤íŒ… ìˆ˜ì • API (ìŠ¤íŠ¸ë¦¬ë° ë²„ì „)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

app.post('/api/revise-stream', async (req, res) => {
  try {
    console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('âš¡ í¬ìŠ¤íŒ… ìˆ˜ì • ìš”ì²­ (ìŠ¤íŠ¸ë¦¬ë°)');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    
    const { currentContent, revisionRequest, chatHistory, originalData } = req.body;
    
    res.setHeader('Content-Type', 'text/event-stream');
    res.setHeader('Cache-Control', 'no-cache');
    res.setHeader('Connection', 'keep-alive');
    
    let prompt = `ë‹¹ì‹ ì€ ë„¤ì´ë²„ ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ìˆ˜ì • ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n\n`;
    
    prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    prompt += `ğŸ“‹ í˜„ì¬ í¬ìŠ¤íŒ…\n`;
    prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    prompt += `${currentContent}\n\n`;
    
    if (originalData) {
      prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
      prompt += `ğŸ“Š ì›ë³¸ ë°ì´í„° (ì°¸ê³ ìš©)\n`;
      prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
      prompt += `í‚¤ì›Œë“œ: ${originalData.keyword}\n`;
      prompt += `ë‹¨ì§€ëª…: ${originalData.complexName}\n`;
      if (originalData.specialNote) {
        prompt += `íŠ¹ì´ì‚¬í•­: ${originalData.specialNote}\n`;
      }
      prompt += `\n`;
    }
    
    if (chatHistory && chatHistory.length > 0) {
      prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
      prompt += `ğŸ’¬ ì´ì „ ëŒ€í™” ë‚´ì—­\n`;
      prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
      chatHistory.slice(-3).forEach((chat) => {
        if (chat.role === 'user') {
          prompt += `ì‚¬ìš©ì: ${chat.content}\n`;
        }
      });
      prompt += `\n`;
    }
    
    prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    prompt += `âœï¸ ìˆ˜ì • ìš”ì²­\n`;
    prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    prompt += `${revisionRequest}\n\n`;
    
    prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    prompt += `ğŸ“ ì‘ë‹µ í˜•ì‹\n`;
    prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    
    prompt += `ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:\n\n`;
    prompt += `<ì„¤ëª…>\n`;
    prompt += `ìˆ˜ì • ë‚´ìš©ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª… (2-3ë¬¸ì¥)\n`;
    prompt += `</ì„¤ëª…>\n\n`;
    prompt += `<ìˆ˜ì •ëœí¬ìŠ¤íŒ…>\n`;
    prompt += `ì „ì²´ í¬ìŠ¤íŒ… ë§ˆí¬ë‹¤ìš´ (ì™„ì „í•œ í˜•íƒœë¡œ)\n`;
    prompt += `</ìˆ˜ì •ëœí¬ìŠ¤íŒ…>\n\n`;
    
    console.log(`\nâš¡ Claude API ìŠ¤íŠ¸ë¦¬ë° í˜¸ì¶œ ì¤‘...\n`);
    
    const stream = await anthropic.messages.stream({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 8000,
      messages: [
        {
          role: 'user',
          content: prompt
        }
      ]
    });
    
    let fullResponse = '';
    
    stream.on('text', (text) => {
      fullResponse += text;
      res.write(`data: ${JSON.stringify({ type: 'chunk', text })}\n\n`);
    });
    
    stream.on('end', () => {
      const explanationMatch = fullResponse.match(/<ì„¤ëª…>([\s\S]*?)<\/ì„¤ëª…>/);
      const revisedMatch = fullResponse.match(/<ìˆ˜ì •ëœí¬ìŠ¤íŒ…>([\s\S]*?)<\/ìˆ˜ì •ëœí¬ìŠ¤íŒ…>/);
      
      const explanation = explanationMatch ? explanationMatch[1].trim() : 'í¬ìŠ¤íŒ…ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.';
      const revisedContent = revisedMatch ? revisedMatch[1].trim() : fullResponse;
      
      res.write(`data: ${JSON.stringify({ 
        type: 'done', 
        explanation, 
        revisedContent 
      })}\n\n`);
      
      res.end();
      
      console.log('\nâœ… ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ');
      console.log(`   - ì „ì²´ ê¸¸ì´: ${fullResponse.length}ì\n`);
    });
    
    stream.on('error', (error) => {
      console.error('ìŠ¤íŠ¸ë¦¬ë° ì—ëŸ¬:', error);
      res.write(`data: ${JSON.stringify({ type: 'error', message: error.message })}\n\n`);
      res.end();
    });
    
  } catch (error) {
    console.error('\nâŒ ì—ëŸ¬ ë°œìƒ:', error.message);
    res.write(`data: ${JSON.stringify({ type: 'error', message: error.message })}\n\n`);
    res.end();
  }
});

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸš€ ì„œë²„ ì‹œì‘
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

app.listen(PORT, () => {
  console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ğŸš€ ì„œë²„ ì‹œì‘! v4.6.1 (ì´ë¯¸ì§€ ë¶„ì„ ê°•í™”!)');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log(`ğŸ“ http://localhost:${PORT}`);
  console.log(`ğŸ“š ê°€ì´ë“œë¼ì¸: ${Object.keys(guidelineManager.guidelines).length}ê°œ ë¡œë“œë¨`);
  console.log(`â­â­â­ ë©”ì¸ ì§€ì¹¨ì„œ: ${guidelineManager.guidelines.mainGuideline ? 'ë¡œë“œë¨!' : 'ì—†ìŒ âŒ'}`);
  console.log(`ğŸ“ ì´ í¬ê¸°: ${Math.round(Object.values(guidelineManager.guidelines).join('').length / 1024)}KB`);
  console.log('ğŸ¯ ì˜ˆìƒ í’ˆì§ˆ: 98%+ (ì´ë¯¸ì§€ ë¶„ì„ + ìê°€í‰ê°€ + ì„œë²„ ê²€ì¦!)');
  console.log('â±ï¸ ìµœëŒ€ ì‹œê°„: 60ì´ˆ (1ì°¨ 30ì´ˆ + ì¬ì‘ì„± 30ì´ˆ)');
  console.log('');
  console.log('âœ¨ v4.6.1 í•µì‹¬ ê¸°ëŠ¥:');
  console.log('   â­â­â­ ì´ë¯¸ì§€ ë¶„ì„ ëª…ì‹œì  ê°•í™”! (í˜„ì¥ê° UP!)');
  console.log('   â­â­â­ Before/After ë¹„êµ ì‹œê°í™”!');
  console.log('   â­â­â­ ë…ìê°€ í˜„ì¥ì— ìˆëŠ” ë“¯í•œ ìƒìƒí•œ ë¬˜ì‚¬!');
  console.log('   â­â­â­ Claude ìê°€í‰ê°€ (14ê°œ í•­ëª©)');
  console.log('   â­â­â­ ì„œë²„ ë ˆë²¨ ìë™ ê²€ì¦ (ì´ì¤‘ ì•ˆì „ì¥ì¹˜)');
  console.log('');
  console.log('âœ… ì´ë¯¸ì§€ ë¶„ì„ í•­ëª©:');
  console.log('   ğŸ–¼ï¸ ì„¤ì¹˜ ì „: ë°ê¸°, ìƒ‰ìƒ, ì–´ë‘ìš´ ì˜ì—­, ë¶„ìœ„ê¸°');
  console.log('   ğŸ”§ ì‘ì—… ì¤‘: ì‘ì—… ë‚´ìš©, ë¶€í’ˆ, ë„êµ¬, ì²œì¥ ìƒíƒœ');
  console.log('   âœ¨ ì„¤ì¹˜ í›„: ë°ê¸° ë³€í™”, ë¹› í™•ì‚°, ìƒ‰ì˜¨ë„, Before/After');
  console.log('');
  console.log('âœ… ê¸°ì¡´ ê¸°ëŠ¥:');
  console.log('   ğŸ“˜ ë©”ì¸ ì§€ì¹¨ì„œ v8.2 ìµœìš°ì„  ë¡œë“œ');
  console.log('   ğŸ“‹ ìê°€í‰ê°€ ì‹œìŠ¤í…œ v2.0 ì™„ì „ í†µí•©');
  console.log('   ğŸ“š guidelines í´ë” 11ê°œ íŒŒì¼ ìë™ ë¡œë“œ');
  console.log('   ğŸ¯ ìƒí™©ë³„ í•„ìš”í•œ ê°€ì´ë“œë§Œ ì„ íƒ');
  console.log('   ğŸ” ë””ë°ìŠ¤ìœ„ì¹˜ ì•„íŒŒíŠ¸ ìë™ ê°ì§€');
  console.log('   ğŸ–¼ï¸ ì´ë¯¸ì§€ Claude ì „ì†¡ + ë¶„ì„');
  console.log('   ğŸ’¬ Claude ëŒ€í™”ë¡œ ìˆ˜ì •');
  console.log('   âš¡ ìŠ¤íŠ¸ë¦¬ë° ì‹¤ì‹œê°„ ì‘ë‹µ');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
});


