<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED ë¸”ë¡œê·¸ ì½˜í…ì¸  ìë™ ìƒì„± ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #9333ea; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        @keyframes fade-in {
            from { 
                opacity: 0; 
                transform: translateY(-10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
        .drop-zone {
            border: 2px dashed #d1d5db;
            transition: all 0.3s;
        }
        .drop-zone.drag-over {
            border-color: #9333ea;
            background-color: #faf5ff;
        }
        #progress-messages::-webkit-scrollbar {
            width: 6px;
        }
        #progress-messages::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-pink-50 min-h-screen">

    <!-- í—¤ë” -->
    <header class="bg-gradient-to-r from-purple-900 to-purple-700 text-white py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex items-center gap-3">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <div>
                    <h1 class="text-3xl font-bold">LED ë¸”ë¡œê·¸ ì½˜í…ì¸  ìë™ ìƒì„± ì‹œìŠ¤í…œ</h1>
                    <p class="text-purple-200 text-sm mt-1">v8.3 | ìŠ¤íŠ¸ë¦¬ë° ì§„í–‰ ìƒí™© í‘œì‹œ + ìë™ ê²€ì¦ & ì¬ì‘ì„± âš¡</p>
                </div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ -->
    <main class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            
            <!-- ì™¼ìª½: ì…ë ¥ í¼ -->
            <div id="left-panel" class="lg:col-span-2 space-y-6">
                
                <!-- í¬ìŠ¤íŒ… íƒ€ì… -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-purple-900 mb-4">í¬ìŠ¤íŒ… íƒ€ì…</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="setPostingType('info')" id="btn-info" class="p-4 rounded-lg border-2 border-gray-200 hover:border-purple-300 transition-all">
                            <div class="font-bold mb-1">ì •ë³´í˜•</div>
                            <div class="text-sm text-gray-600">ì§€ì‹/ê°€ì´ë“œ ì¤‘ì‹¬</div>
                        </button>
                        <button onclick="setPostingType('case')" id="btn-case" class="p-4 rounded-lg border-2 border-purple-600 bg-purple-50 text-purple-900 transition-all">
                            <div class="font-bold mb-1">ì‚¬ë¡€í˜•</div>
                            <div class="text-sm text-gray-600">ì‹œê³µ ì‚¬ë¡€ ì¤‘ì‹¬</div>
                        </button>
                    </div>
                </div>

                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-purple-900 mb-4">ê¸°ë³¸ ì •ë³´</h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ë©”ì¸í‚¤ì›Œë“œ <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="keyword" placeholder="ì˜ˆ: ì†¡ë„LEDì¡°ëª…" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>

                    <div id="case-fields">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ë‹¨ì§€ëª… <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="complexName" placeholder="ì˜ˆ: ì†¡ë„ íìŠ¤í…Œì´íŠ¸" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                </div>

                <!-- ì—‘ì…€ ì—…ë¡œë“œ -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-purple-900 mb-4">ê³µê°„ ë°ì´í„° ì…ë ¥</h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ â­ ì¶”ì²œ
                        </label>
                        <div id="excel-drop-zone" class="drop-zone rounded-lg p-8 text-center cursor-pointer">
                            <input type="file" id="excel-input" accept=".xlsx,.xls" class="hidden">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <p class="text-gray-600 font-medium mb-2">ğŸ“ ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                            <p class="text-sm text-gray-500 mb-1">ê³µê°„ë³„ ì‹œê³µìœ í˜•, ë“±ê¸°êµ¬, ì œí’ˆ, ì†Œë¹„ì „ë ¥, ì¡°ë„</p>
                            <p class="text-xs text-purple-600 mb-3">âœ¨ ì¶”ê°€ì‘ì—… ì •ë³´ë„ í•¨ê»˜ ì…ë ¥ ê°€ëŠ¥</p>
                            <button onclick="downloadTemplate()" class="text-sm text-purple-600 hover:text-purple-700 font-medium">
                                ğŸ“¥ ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                        <div id="excel-status" class="hidden mt-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                            <p class="text-sm text-green-800 font-medium">âœ… ì—‘ì…€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!</p>
                            <p id="excel-summary" class="text-xs text-green-700 mt-1"></p>
                        </div>
                    </div>

                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ë¶ˆëŸ¬ì˜¨ ê³µê°„ ë°ì´í„°
                        </label>
                        <div id="space-data-container" class="space-y-3 max-h-96 overflow-y-auto">
                            <p class="text-sm text-gray-500 text-center py-4">ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="text-sm font-medium space-y-1">
                            <div class="flex justify-between">
                                <span>ì´ ê³µê°„ ìˆ˜:</span>
                                <span id="total-spaces" class="text-purple-600">0ê°œ</span>
                            </div>
                            <div class="flex justify-between">
                                <span>ì´ ì ˆê° ì „ë ¥:</span>
                                <span id="total-savings" class="text-green-600">0W</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì¶”ê°€ ì‘ì—… ì •ë³´ -->
                <div id="additional-work-section" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-purple-900 mb-4">ì¶”ê°€ ì‘ì—… ì •ë³´</h2>
                    <div id="additional-work-content" class="space-y-2 text-sm">
                    </div>
                </div>

                <!-- ì‹œê³µ ì •ë³´ -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-purple-900 mb-4">ì‹œê³µ ì •ë³´</h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ì‹œê³µ ì‚¬ìœ  <span class="text-red-500">*</span>
                        </label>
                        <textarea 
                            id="construction-reason" 
                            rows="3" 
                            placeholder="ì˜ˆ: í˜•ê´‘ë“± ë…¸í›„ë¡œ ê¹œë¹¡ì„ ë°œìƒ, ë°ê¸°ê°€ ë¶€ì¡±í•´ ë¶ˆí¸í•˜ì…¨ë‹¤ê³  í•˜ì…¨ìŠµë‹ˆë‹¤."
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                        ></textarea>
                        <p class="text-xs text-gray-500 mt-1">ğŸ’¡ ë³µì‚¬-ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥ (Ctrl+V)</p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ê³ ê° í›„ê¸°/ë°˜ì‘ <span class="text-red-500">*</span>
                        </label>
                        <textarea 
                            id="customer-review" 
                            rows="3" 
                            placeholder="ì˜ˆ: ê±°ì‹¤ì´ ì •ë§ ë°ì•„ì ¸ì„œ ë§Œì¡±ìŠ¤ëŸ½ë‹¤ê³  í•˜ì…¨ìŠµë‹ˆë‹¤. ì „ê¸°ì„¸ë„ ë§ì´ ì¤„ì–´ë“¤ ê²ƒ ê°™ì•„ ê¸°ëŒ€ëœë‹¤ê³ ..."
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                        ></textarea>
                        <p class="text-xs text-gray-500 mt-1">ğŸ’¡ ë³µì‚¬-ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥ (Ctrl+V)</p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            íŠ¹ì´ì‚¬í•­ (ì„ íƒì‚¬í•­)
                        </label>
                        <textarea 
                            id="special-note" 
                            rows="3" 
                            placeholder="ì˜ˆ: ë””ë° ìŠ¤ìœ„ì¹˜ êµì²´, íŠ¹ìˆ˜ ì‹œê³µ ì¡°ê±´, íŠ¹ë³„ ìš”ì²­ì‚¬í•­ ë“±..."
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                        ></textarea>
                        <p class="text-xs text-gray-500 mt-1">ğŸ’¡ í¬ìŠ¤íŒ…ì— ë°˜ì˜í•  íŠ¹ë³„í•œ ì‚¬í•­ì´ ìˆë‹¤ë©´ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                    </div>
                </div>

                <!-- ì‚¬ì§„ ì—…ë¡œë“œ -->
                <div id="photo-section" class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-purple-900 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        ì‚¬ì§„ ì—…ë¡œë“œ
                        <span class="text-red-500 text-sm">* í•„ìˆ˜</span>
                    </h2>
                    <div id="photo-drop-zone" class="drop-zone rounded-lg p-8 text-center cursor-pointer">
                        <input type="file" id="photo-input" multiple accept="image/*" class="hidden">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <p class="text-gray-600 font-medium mb-2">ğŸ“¸ ì‚¬ì§„ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                        <p class="text-sm text-gray-500">ì„¤ì¹˜ ì „/ì¤‘/í›„ ì‚¬ì§„</p>
                    </div>
                    <div id="photo-list" class="mt-4 grid grid-cols-2 gap-3"></div>
                    <div id="photo-validation" class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between text-sm">
                            <span class="font-medium text-gray-700">í•„ìˆ˜ ì‚¬ì§„:</span>
                            <div class="flex gap-3">
                                <span id="check-before" class="text-gray-400">âŒ ì „</span>
                                <span id="check-working" class="text-gray-400">âŒ ì¤‘</span>
                                <span id="check-after" class="text-gray-400">âŒ í›„</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
                <div id="error-message" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex items-start gap-2">
                        <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="text-sm text-red-800">
                            <p class="font-medium mb-1">ì˜¤ë¥˜</p>
                            <p id="error-text"></p>
                        </div>
                    </div>
                </div>

                <!-- ìƒì„± ë²„íŠ¼ -->
                <button onclick="generateBlogPost()" id="generate-btn" class="w-full py-4 rounded-lg font-bold text-lg shadow-lg bg-gradient-to-r from-purple-600 to-purple-700 text-white hover:shadow-xl transition-all flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ìë™ ìƒì„±
                </button>

            </div>

            <!-- ì˜¤ë¥¸ìª½: ë¯¸ë¦¬ë³´ê¸° & ìˆ˜ì • -->
            <div id="right-panel" class="lg:col-span-3 space-y-6">
                
                <!-- ë¯¸ë¦¬ë³´ê¸°/ìˆ˜ì • íƒ­ -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <!-- íƒ­ í—¤ë” -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex gap-2">
                            <button onclick="switchTab('preview')" id="tab-preview" class="px-4 py-2 rounded-lg font-medium bg-purple-600 text-white">
                                ğŸ“– ë¯¸ë¦¬ë³´ê¸°
                            </button>
                            <button onclick="switchTab('edit')" id="tab-edit" class="hidden px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-600">
                                âœï¸ ìˆ˜ì •í•˜ê¸°
                            </button>
                            <button onclick="switchTab('chat')" id="tab-chat" class="hidden px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-600">
                                ğŸ’¬ Claude ëŒ€í™”
                            </button>
                        </div>
                        <div id="status-badge" class="hidden px-3 py-1 rounded-full text-xs font-bold"></div>
                    </div>

                    <!-- ë¯¸ë¦¬ë³´ê¸° íƒ­ -->
                    <div id="preview-tab" class="bg-gray-50 rounded-lg p-6 min-h-[400px] max-h-[600px] overflow-y-auto">
                        <div id="preview-content" class="text-center text-gray-400 py-20">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p>ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ìƒì„± ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
                            <p class="text-sm mt-2">ì—‘ì…€ ì—…ë¡œë“œë¡œ ë¹ ë¥¸ ì…ë ¥!</p>
                        </div>
                    </div>

                    <!-- ìˆ˜ì • íƒ­ -->
                    <div id="edit-tab" class="hidden">
                        <textarea id="edit-content" class="w-full h-[500px] p-4 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-purple-500" placeholder="ì—¬ê¸°ì„œ í¬ìŠ¤íŒ…ì„ ìˆ˜ì •í•˜ì„¸ìš”..."></textarea>
                        <div class="mt-4 flex gap-2">
                            <button onclick="applyEdit()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                ìˆ˜ì • ì ìš©
                            </button>
                            <button onclick="cancelEdit()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-medium">
                                ì·¨ì†Œ
                            </button>
                        </div>
                    </div>

                    <!-- Claude ëŒ€í™” íƒ­ (2ì—´ ë ˆì´ì•„ì›ƒ) -->
                    <div id="chat-tab" class="hidden grid grid-cols-2 gap-4">
                        <!-- ì™¼ìª½: ë¯¸ë¦¬ë³´ê¸° -->
                        <div class="border-r border-gray-300 pr-4">
                            <h3 class="text-lg font-bold text-purple-900 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                í¬ìŠ¤íŒ… ë¯¸ë¦¬ë³´ê¸°
                            </h3>
                            <div id="chat-preview" class="bg-gray-50 rounded-lg p-4 h-[550px] overflow-y-auto text-sm">
                                <div class="text-center text-gray-400 py-20">
                                    <p>í¬ìŠ¤íŒ…ì„ ìƒì„±í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ì˜¤ë¥¸ìª½: ì±„íŒ…ì°½ -->
                        <div>
                            <h3 class="text-lg font-bold text-purple-900 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                Claudeì™€ ëŒ€í™”
                            </h3>
                            
                            <!-- â­ ìˆ˜ì • ìš”ì²­ ëª©ë¡ -->
                            <div id="revision-list-panel" class="hidden mb-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="font-bold text-sm text-gray-700 flex items-center gap-1">
                                        ğŸ“ ìˆ˜ì • ìš”ì²­ ëª©ë¡
                                        <span id="revision-count" class="text-purple-600 ml-1">(0)</span>
                                    </h4>
                                    <button onclick="clearRevisionRequests()" class="text-xs text-red-600 hover:text-red-800">
                                        ì „ì²´ ì‚­ì œ
                                    </button>
                                </div>
                                <div id="revision-list" class="space-y-2 max-h-[400px] overflow-y-auto text-sm">
                                    <!-- ìˆ˜ì • ìš”ì²­ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
                                </div>
                            </div>
                            
                            <!-- ëŒ€í™” íˆìŠ¤í† ë¦¬ -->
                            <div id="chat-history" class="bg-gray-50 rounded-lg p-4 h-[400px] overflow-y-auto mb-4 space-y-3">
                                <div class="text-center text-gray-400 py-20">
                                    <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                    <p>Claudeì™€ ëŒ€í™”í•˜ë©° í¬ìŠ¤íŒ…ì„ ìˆ˜ì •í•´ë³´ì„¸ìš”</p>
                                    <p class="text-sm mt-2">ì˜ˆ: "í›„í‚¹ ì§ˆë¬¸ì„ ë” êµ¬ì²´ì ìœ¼ë¡œ ë°”ê¿”ì¤˜"</p>
                                </div>
                            </div>
                            
                            <!-- ì…ë ¥ì°½ -->
                            <div class="flex gap-2 mb-3">
                                <input 
                                    type="text" 
                                    id="chat-input" 
                                    placeholder="ìˆ˜ì • ìš”ì²­ì„ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: í›„í‚¹ ì§ˆë¬¸ì„ ë” êµ¬ì²´ì ìœ¼ë¡œ ë°”ê¿”ì¤˜)" 
                                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); addRevisionRequest(); }"
                                >
                                <button onclick="addRevisionRequest()" id="add-revision-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                                    â• ì¶”ê°€
                                </button>
                            </div>
                            
                            <!-- â­ ëª¨ë“  ìˆ˜ì •ì‚¬í•­ ë°˜ì˜ ë²„íŠ¼ -->
                            <button onclick="applyAllRevisions()" id="apply-all-btn" class="hidden w-full py-3 mb-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                ğŸ¯ ëª¨ë“  ìˆ˜ì •ì‚¬í•­ í•œë²ˆì— ë°˜ì˜
                            </button>
                            
                            <!-- í™•ì • ë²„íŠ¼ -->
                            <div class="flex gap-2">
                                <button onclick="finalizeContent()" id="finalize-btn" class="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    âœ… í¬ìŠ¤íŒ… í™•ì •
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
                    <div id="download-buttons" class="hidden mt-4 grid grid-cols-3 gap-3">
                        <button onclick="downloadMarkdown()" class="py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium text-sm">
                            ğŸ“¥ ë§ˆí¬ë‹¤ìš´
                        </button>
                        <button onclick="downloadHTML()" class="py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium text-sm">
                            ğŸ¨ HTML
                        </button>
                        <button onclick="copyToClipboard()" class="py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-medium text-sm">
                            ğŸ“‹ ë³µì‚¬
                        </button>
                    </div>
                </div>

                <!-- ìê°€í‰ê°€ -->
                <div id="evaluation-panel" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-purple-900 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        ìê°€í‰ê°€ v2.0
                    </h2>
                    <div id="evaluation-content"></div>
                </div>

            </div>

        </div>
    </main>

    <!-- í‘¸í„° -->
    <footer class="bg-gray-100 py-6 mt-12">
        <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
            <p>LED ë¸”ë¡œê·¸ ì½˜í…ì¸  ìë™ ìƒì„± ì‹œìŠ¤í…œ v8.3 | ìŠ¤íŠ¸ë¦¬ë° ì§„í–‰ ìƒí™© í‘œì‹œ + ìë™ ê²€ì¦ & ì¬ì‘ì„± âš¡</p>
            <p class="mt-1">ğŸ“Š ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© | ğŸ” ì„œë²„ ë ˆë²¨ ìë™ ê²€ì¦ (Level 1~3) | ğŸ”„ 1íšŒ ìë™ ì¬ì‘ì„±</p>
        </div>
    </footer>

    <script>
        let state = {
            postingType: 'case',
            keyword: '',
            complexName: '',
            spaceData: [],
            additionalWork: {},
            constructionReason: '',
            customerReview: '',
            specialNote: '',
            photos: [],
            generatedContent: '',
            // â­ ìˆ˜ì • ëŒ€í™” ê´€ë ¨
            revisionMode: false,
            revisionHistory: [],
            currentRevision: '',
            // â­ Claude ëŒ€í™” ê´€ë ¨
            chatHistory: [],
            isFinalized: false,
            originalData: null,  // ì›ë³¸ ì…ë ¥ ë°ì´í„° ì €ì¥
            // â­ ìˆ˜ì • ìš”ì²­ ëˆ„ì 
            revisionRequests: []  // ìˆ˜ì • ìš”ì²­ ë°°ì—´
        };

        document.addEventListener('DOMContentLoaded', () => {
            setupExcelUpload();
            setupPhotoUpload();
            updateCaseFields();
        });

        function setPostingType(type) {
            state.postingType = type;
            document.getElementById('btn-info').className = type === 'info' 
                ? 'p-4 rounded-lg border-2 border-purple-600 bg-purple-50 text-purple-900 transition-all'
                : 'p-4 rounded-lg border-2 border-gray-200 hover:border-purple-300 transition-all';
            document.getElementById('btn-case').className = type === 'case'
                ? 'p-4 rounded-lg border-2 border-purple-600 bg-purple-50 text-purple-900 transition-all'
                : 'p-4 rounded-lg border-2 border-gray-200 hover:border-purple-300 transition-all';
            updateCaseFields();
        }

        function updateCaseFields() {
            document.getElementById('case-fields').style.display = state.postingType === 'case' ? 'block' : 'none';
            document.getElementById('photo-section').style.display = state.postingType === 'case' ? 'block' : 'none';
        }

        function setupExcelUpload() {
            const dropZone = document.getElementById('excel-drop-zone');
            const fileInput = document.getElementById('excel-input');

            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleExcelFile);

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                if (e.dataTransfer.files.length > 0) {
                    handleExcelFile({ target: { files: e.dataTransfer.files } });
                }
            });
        }

        function handleExcelFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    if (workbook.SheetNames.includes('ê³µê°„ë³„ ë°ì´í„°')) {
                        const sheet1 = workbook.Sheets['ê³µê°„ë³„ ë°ì´í„°'];
                        const jsonData = XLSX.utils.sheet_to_json(sheet1);

                        state.spaceData = jsonData.map(row => ({
                            space: row['ê³µê°„'] || '',
                            constructionType: row['ì‹œê³µìœ í˜•'] || 'LED ë¦¬í¼',
                            fixture: row['ë“±ê¸°êµ¬'] || '',
                            oldProduct: row['ê¸°ì¡´ì œí’ˆ'] || '',
                            oldPower: parseInt(row['ê¸°ì¡´ì†Œë¹„ì „ë ¥(W)']) || 0,
                            newProduct: row['ìƒˆì œí’ˆ'] || '',
                            newPower: parseInt(row['ìƒˆì†Œë¹„ì „ë ¥(W)']) || 0,
                            oldLux: row['ê¸°ì¡´ì¡°ë„(lux)'] || '',
                            newLux: row['ìƒˆì¡°ë„(lux)'] || ''
                        })).filter(item => item.space);
                    }

                    if (workbook.SheetNames.includes('ì¶”ê°€ì‘ì—…')) {
                        const sheet2 = workbook.Sheets['ì¶”ê°€ì‘ì—…'];
                        const additionalData = XLSX.utils.sheet_to_json(sheet2);
                        
                        state.additionalWork = {};
                        additionalData.forEach(row => {
                            const key = row['í•­ëª©'];
                            const value = row['ë‚´ìš©'];
                            if (key && value) {
                                state.additionalWork[key] = value;
                            }
                        });
                    }

                    renderSpaceData();
                    renderAdditionalWork();
                    
                    const statusDiv = document.getElementById('excel-status');
                    const summaryText = document.getElementById('excel-summary');
                    statusDiv.classList.remove('hidden');
                    summaryText.textContent = `ê³µê°„ ${state.spaceData.length}ê°œ, ì¶”ê°€ì‘ì—… ${Object.keys(state.additionalWork).length}ê°œ`;
                    
                    setTimeout(() => statusDiv.classList.add('hidden'), 5000);

                } catch (error) {
                    alert('ì—‘ì…€ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function renderSpaceData() {
            const container = document.getElementById('space-data-container');
            if (state.spaceData.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ë©´ í‘œì‹œë©ë‹ˆë‹¤</p>';
                updateTotals();
                return;
            }

            container.innerHTML = state.spaceData.map((item, index) => `
                <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <span class="font-bold text-purple-900">${item.space}</span>
                            <span class="ml-2 text-xs px-2 py-1 rounded-full ${getConstructionTypeBadge(item.constructionType)}">${item.constructionType}</span>
                        </div>
                        <button onclick="removeSpace(${index})" class="text-red-500 hover:text-red-700 text-sm">ì‚­ì œ</button>
                    </div>
                    <div class="text-xs text-gray-600 space-y-1">
                        ${item.fixture ? `<div>ë“±ê¸°êµ¬: ${item.fixture}</div>` : ''}
                        <div>ê¸°ì¡´: ${item.oldProduct} (${item.oldPower}W)</div>
                        <div>ì‹ ê·œ: ${item.newProduct} (${item.newPower}W)</div>
                        <div class="text-green-600 font-medium">ì ˆê°: ${item.oldPower - item.newPower}W</div>
                        ${item.oldLux ? `<div class="text-blue-600">ì¡°ë„: ${item.oldLux} â†’ ${item.newLux} lux</div>` : ''}
                    </div>
                </div>
            `).join('');

            updateTotals();
        }

        function getConstructionTypeBadge(type) {
            const lower = type.toLowerCase();
            if (lower.includes('ë¦¬í¼')) return 'bg-blue-100 text-blue-800';
            if (lower.includes('ì „ì²´') || lower.includes('êµì²´')) return 'bg-green-100 text-green-800';
            if (lower.includes('ì‹¤ë§íŒ¬') || lower.includes('íŒ¬')) return 'bg-purple-100 text-purple-800';
            if (lower.includes('ë””ë°')) return 'bg-yellow-100 text-yellow-800';
            return 'bg-gray-100 text-gray-800';
        }

        function renderAdditionalWork() {
            const section = document.getElementById('additional-work-section');
            const content = document.getElementById('additional-work-content');

            if (Object.keys(state.additionalWork).length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            content.innerHTML = Object.entries(state.additionalWork)
                .map(([key, value]) => `
                    <div class="flex items-start gap-2">
                        <span class="text-purple-600">â€¢</span>
                        <div class="flex-1">
                            <span class="font-medium text-gray-700">${key}:</span>
                            <span class="text-gray-600">${value}</span>
                        </div>
                    </div>
                `).join('');
        }

        function updateTotals() {
            document.getElementById('total-spaces').textContent = `${state.spaceData.length}ê°œ`;
            const totalSavings = state.spaceData.reduce((sum, item) => sum + (item.oldPower - item.newPower), 0);
            document.getElementById('total-savings').textContent = `${totalSavings}W`;
        }

        function removeSpace(index) {
            state.spaceData.splice(index, 1);
            renderSpaceData();
        }

        function downloadTemplate() {
            const sheet1Data = [
                ['ê³µê°„', 'ì‹œê³µìœ í˜•', 'ë“±ê¸°êµ¬', 'ê¸°ì¡´ì œí’ˆ', 'ê¸°ì¡´ì†Œë¹„ì „ë ¥(W)', 'ìƒˆì œí’ˆ', 'ìƒˆì†Œë¹„ì „ë ¥(W)', 'ê¸°ì¡´ì¡°ë„(lux)', 'ìƒˆì¡°ë„(lux)'],
                ['ê±°ì‹¤', 'LED ë¦¬í¼', 'ì—…ì†Œ ë¬´ê±°ìš´ ìš°ë¦¬ì»¤ë²„ ì§ì‚¬ê° ê±°ì‹¤3ë“± ì§ë¶€', '55W PLí˜•ê´‘ë“± 2ê°œ x 3ì¹¸', 330, '50W LED ëª¨ë“ˆ 1ê°œ x 3ì¹¸', 150, 655, 2556],
                ['ì£¼ë°©', 'ì „ì²´ êµì²´', 'ì£¼ë°©ë“± (ìƒˆ ë“±ê¸°êµ¬)', '36W ì›í˜• í˜•ê´‘ë“± 2ê°œ', 72, '25W LED ì¼ì²´í˜• 2ê°œ', 50, 450, 1200],
                ['ì•ˆë°©', 'LED ë¦¬í¼', 'ì¹¨ì‹¤ë“±', '32W í˜•ê´‘ë“±', 32, '20W LED ëª¨ë“ˆ', 20, 300, 800],
                ['ìš•ì‹¤', 'ì‹¤ë§íŒ¬ ì„¤ì¹˜', 'ìš•ì‹¤ë“±', '20W', 20, 'ì‹¤ë§íŒ¬ 15W', 15, '', '']
            ];

            const sheet2Data = [
                ['í•­ëª©', 'ë‚´ìš©'],
                ['ë””ë°ìŠ¤ìœ„ì¹˜ ì²˜ë¦¬', 'ì¼ë°˜ìŠ¤ìœ„ì¹˜ë¡œ êµì²´ (ê±°ì‹¤, ì•ˆë°©)'],
                ['ìŠ¤ìœ„ì¹˜ ì‘ì—…', 'ì¤‘ê³  ë³µì› 2ê°œ'],
                ['ê¸°íƒ€ ì‘ì—…', 'ë°°ì„  ì •ë¦¬'],
                ['íŠ¹ì´ì‚¬í•­', 'ê¸°ì¡´ ë“±ê¸°êµ¬ ìƒíƒœ ì–‘í˜¸']
            ];

            const wb = XLSX.utils.book_new();
            const ws1 = XLSX.utils.aoa_to_sheet(sheet1Data);
            ws1['!cols'] = [
                { wch: 8 }, { wch: 20 }, { wch: 35 }, { wch: 30 },
                { wch: 15 }, { wch: 30 }, { wch: 15 }, { wch: 12 }, { wch: 12 }
            ];
            XLSX.utils.book_append_sheet(wb, ws1, 'ê³µê°„ë³„ ë°ì´í„°');
            
            const ws2 = XLSX.utils.aoa_to_sheet(sheet2Data);
            ws2['!cols'] = [{ wch: 20 }, { wch: 50 }];
            XLSX.utils.book_append_sheet(wb, ws2, 'ì¶”ê°€ì‘ì—…');
            
            XLSX.writeFile(wb, 'LEDë¸”ë¡œê·¸_í…œí”Œë¦¿_v2.xlsx');
        }

        function setupPhotoUpload() {
            const dropZone = document.getElementById('photo-drop-zone');
            const fileInput = document.getElementById('photo-input');

            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handlePhotoUpload);

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                if (e.dataTransfer.files.length > 0) {
                    handlePhotoUpload({ target: { files: e.dataTransfer.files } });
                }
            });
        }

        function handlePhotoUpload(e) {
            Array.from(e.target.files).forEach(file => {
                if (!file.type.startsWith('image/')) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    state.photos.push({
                        id: Date.now() + Math.random(),
                        name: file.name,
                        size: file.size,
                        stage: detectPhotoStage(file.name),
                        space: detectSpace(file.name),
                        preview: event.target.result,
                        file: file  // â­ ì‹¤ì œ íŒŒì¼ ê°ì²´ ì €ì¥!
                    });
                    renderPhotos();
                };
                reader.readAsDataURL(file);
            });
        }

        function detectPhotoStage(filename) {
            const lower = filename.toLowerCase();
            if (lower.includes('ì„¤ì¹˜ì „') || lower.includes('before')) return 'before';
            if (lower.includes('ì„¤ì¹˜ì¤‘') || lower.includes('ì‘ì—…ì¤‘') || lower.includes('working')) return 'working';
            if (lower.includes('ì„¤ì¹˜í›„') || lower.includes('after')) return 'after';
            return 'unknown';
        }

        function detectSpace(filename) {
            const lower = filename.toLowerCase();
            if (lower.includes('ê±°ì‹¤')) return 'ê±°ì‹¤';
            if (lower.includes('ì£¼ë°©')) return 'ì£¼ë°©';
            if (lower.includes('ì•ˆë°©')) return 'ì•ˆë°©';
            if (lower.includes('ìš•ì‹¤')) return 'ìš•ì‹¤';
            return 'ë¯¸ì§€ì •';
        }

        function renderPhotos() {
            const container = document.getElementById('photo-list');
            if (state.photos.length === 0) {
                container.innerHTML = '';
                updatePhotoValidation();
                return;
            }

            container.innerHTML = state.photos.map(photo => `
                <div class="relative border border-gray-200 rounded-lg p-2">
                    <img src="${photo.preview}" class="w-full aspect-video object-cover rounded mb-2">
                    <p class="text-xs font-medium text-gray-700 truncate">${photo.name}</p>
                    <div class="flex items-center justify-between mt-1">
                        <span class="text-xs px-2 py-0.5 rounded-full ${getStageBadgeColor(photo.stage)}">${getStageLabel(photo.stage)}</span>
                        <span class="text-xs text-gray-500">${formatFileSize(photo.size)}</span>
                    </div>
                    <button onclick="removePhoto('${photo.id}')" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 hover:bg-red-600">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `).join('');

            updatePhotoValidation();
        }

        function updatePhotoValidation() {
            const hasBefore = state.photos.some(p => p.stage === 'before');
            const hasWorking = state.photos.some(p => p.stage === 'working');
            const hasAfter = state.photos.some(p => p.stage === 'after');

            document.getElementById('check-before').textContent = hasBefore ? 'âœ… ì „' : 'âŒ ì „';
            document.getElementById('check-before').className = hasBefore ? 'text-green-600' : 'text-gray-400';

            document.getElementById('check-working').textContent = hasWorking ? 'âœ… ì¤‘' : 'âŒ ì¤‘';
            document.getElementById('check-working').className = hasWorking ? 'text-green-600' : 'text-gray-400';

            document.getElementById('check-after').textContent = hasAfter ? 'âœ… í›„' : 'âŒ í›„';
            document.getElementById('check-after').className = hasAfter ? 'text-green-600' : 'text-gray-400';
        }

        function removePhoto(id) {
            state.photos = state.photos.filter(p => p.id !== parseFloat(id));
            renderPhotos();
        }

        function getStageBadgeColor(stage) {
            const colors = {
                'before': 'bg-blue-100 text-blue-800',
                'working': 'bg-yellow-100 text-yellow-800',
                'after': 'bg-green-100 text-green-800',
                'unknown': 'bg-gray-100 text-gray-800'
            };
            return colors[stage];
        }

        function getStageLabel(stage) {
            const labels = {
                'before': 'ì„¤ì¹˜ ì „',
                'working': 'ì‘ì—… ì¤‘',
                'after': 'ì„¤ì¹˜ í›„',
                'unknown': 'ë¯¸ë¶„ë¥˜'
            };
            return labels[stage];
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        async function generateBlogPost() {
            state.keyword = document.getElementById('keyword').value;
            state.complexName = document.getElementById('complexName').value;
            state.constructionReason = document.getElementById('construction-reason').value;
            state.customerReview = document.getElementById('customer-review').value;
            state.specialNote = document.getElementById('special-note').value;

            if (!state.keyword.trim()) {
                showError('ë©”ì¸í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (state.postingType === 'case') {
                if (!state.complexName.trim()) {
                    showError('ë‹¨ì§€ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (state.spaceData.length === 0) {
                    showError('ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ê³µê°„ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (!state.constructionReason.trim()) {
                    showError('ì‹œê³µ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (!state.customerReview.trim()) {
                    showError('ê³ ê° í›„ê¸°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const hasBefore = state.photos.some(p => p.stage === 'before');
                const hasWorking = state.photos.some(p => p.stage === 'working');
                const hasAfter = state.photos.some(p => p.stage === 'after');
                if (!hasBefore || !hasWorking || !hasAfter) {
                    showError('ì„¤ì¹˜ ì „/ì¤‘/í›„ ì‚¬ì§„ì„ ëª¨ë‘ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                    return;
                }
            }

            try {
                hideError();
                showLoading();

                // â­ FormData ë°©ì‹ìœ¼ë¡œ ì „ì†¡ (ì´ë¯¸ì§€ íŒŒì¼ í¬í•¨)
                const formData = new FormData();
                
                // í…ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ JSON ë¬¸ìì—´ë¡œ
                const dataJson = {
                    postingType: state.postingType,
                    keyword: state.keyword,
                    complexName: state.complexName,
                    spaceData: state.spaceData,
                    additionalWork: state.additionalWork,
                    constructionReason: state.constructionReason,
                    customerReview: state.customerReview,
                    specialNote: state.specialNote
                };
                formData.append('data', JSON.stringify(dataJson));
                
                // ì‹¤ì œ ì´ë¯¸ì§€ íŒŒì¼ë“¤
                for (const photo of state.photos) {
                    if (photo.file) {
                        formData.append('images', photo.file, photo.name);
                    }
                }

                // â­â­â­ ìŠ¤íŠ¸ë¦¬ë° API í˜¸ì¶œ (ì§„í–‰ ìƒí™© ì‹¤ì‹œê°„ í‘œì‹œ)
                const response = await fetch('/api/generate-stream', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);

                // â­ SSE(Server-Sent Events) ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop(); // ë§ˆì§€ë§‰ ë¶ˆì™„ì „í•œ ì¤„ ë³´ê´€
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            
                            if (data.type === 'progress') {
                                // ì§„í–‰ ìƒí™© í‘œì‹œ
                                addProgressMessage(data.message);
                            } else if (data.type === 'done') {
                                // ì™„ë£Œ
                                addProgressMessage('âœ… ì™„ë£Œ!', true);
                                
                                state.generatedContent = data.content;
                                
                                // â­ ì›ë³¸ ë°ì´í„° ì €ì¥ (ìˆ˜ì • ìš”ì²­ ì‹œ ì‚¬ìš©)
                                state.originalData = {
                                    postingType: state.postingType,
                                    keyword: state.keyword,
                                    complexName: state.complexName,
                                    spaceData: state.spaceData,
                                    additionalWork: state.additionalWork,
                                    constructionReason: state.constructionReason,
                                    customerReview: state.customerReview,
                                    specialNote: state.specialNote
                                };
                                
                                showPreview(state.generatedContent);
                                
                                // â­ ìˆ˜ì • & Claude ëŒ€í™” íƒ­ í™œì„±í™”
                                document.getElementById('tab-edit').classList.remove('hidden');
                                document.getElementById('tab-chat').classList.remove('hidden');
                                
                                // â­ ìƒíƒœ ì—…ë°ì´íŠ¸
                                updateStatusBadge('ìƒì„± ì™„ë£Œ', 'bg-blue-500');
                                
                                // í†µê³„ ë¡œê·¸
                                if (data.stats) {
                                    console.log('ğŸ“Š í†µê³„:', data.stats);
                                    console.log('ğŸ”„ ì‹œë„ íšŸìˆ˜:', data.attempts);
                                    if (data.remainingIssues && data.remainingIssues.length > 0) {
                                        console.log('âš ï¸ ë‚¨ì€ ë¬¸ì œ:', data.remainingIssues);
                                    }
                                }
                                
                            } else if (data.type === 'error') {
                                // ì—ëŸ¬
                                addProgressMessage(`âŒ ì—ëŸ¬: ${data.message}`, true);
                                throw new Error(data.message);
                            }
                        }
                    }
                }

            } catch (error) {
                showError(error.message || 'í¬ìŠ¤íŒ… ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function showLoading() {
            document.getElementById('preview-content').innerHTML = `
                <div class="text-center py-10">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="font-bold text-gray-800 text-lg mb-2">í¬ìŠ¤íŒ… ìƒì„± ì¤‘...</p>
                    <div id="progress-messages" class="mt-6 space-y-2 text-left max-w-2xl mx-auto bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                        <div class="text-sm text-gray-500 italic">ì§„í–‰ ìƒí™©ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤...</div>
                    </div>
                    <p class="text-sm text-gray-500 mt-4">ì˜ˆìƒ ì‹œê°„: 30~60ì´ˆ</p>
                </div>
            `;
        }
        
        function addProgressMessage(message, isComplete = false) {
            const container = document.getElementById('progress-messages');
            if (!container) return;
            
            // ì²« ë©”ì‹œì§€ë©´ ì´ˆê¸°í™”
            if (container.querySelector('.italic')) {
                container.innerHTML = '';
            }
            
            const div = document.createElement('div');
            div.className = isComplete ? 'text-sm text-green-600 font-medium animate-fade-in' : 'text-sm text-blue-600 animate-fade-in';
            div.textContent = message;
            
            // ì´ì „ ë©”ì‹œì§€ë“¤ì„ íšŒìƒ‰ìœ¼ë¡œ
            const prevMessages = container.querySelectorAll('.text-blue-600');
            prevMessages.forEach(msg => {
                msg.classList.remove('text-blue-600');
                msg.classList.add('text-gray-500');
            });
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showPreview(content) {
            document.getElementById('preview-content').innerHTML = `
                <pre class="whitespace-pre-wrap text-sm bg-white p-4 rounded border border-gray-200 font-mono text-left">${content}</pre>
            `;
            // â­ í™•ì •ëœ ê²½ìš°ì—ë§Œ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
            if (state.isFinalized) {
                document.getElementById('download-buttons').classList.remove('hidden');
            }
        }

        function showEvaluation(result) {
            const panel = document.getElementById('evaluation-panel');
            const content = document.getElementById('evaluation-content');

            content.innerHTML = `
                <div class="space-y-4">
                    <div class="border-2 rounded-lg p-4 ${result.level1.pass ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
                        <h3 class="font-bold mb-2">Level 1: ì¹˜ëª…ì  í˜•ì‹ ${result.level1.pass ? 'âœ…' : 'âŒ'}</h3>
                    </div>
                    <div class="border-2 rounded-lg p-4 ${result.level2.pass ? 'border-green-200 bg-green-50' : 'border-amber-200 bg-amber-50'}">
                        <h3 class="font-bold mb-2">Level 2: í•„ìˆ˜ í˜•ì‹ ${result.level2.pass ? 'âœ…' : 'âš ï¸'}</h3>
                    </div>
                    <div class="border-2 border-purple-200 bg-purple-50 rounded-lg p-4">
                        <div class="flex justify-between">
                            <h3 class="font-bold">Level 3: í’ˆì§ˆ</h3>
                            <span class="text-2xl font-bold text-purple-600">${result.level3.overallScore}/100</span>
                        </div>
                    </div>
                </div>
            `;
            panel.classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').classList.remove('hidden');
            setTimeout(() => document.getElementById('error-message').classList.add('hidden'), 5000);
        }

        function hideError() {
            document.getElementById('error-message').classList.add('hidden');
        }

        // íƒ­ ì „í™˜
        function switchTab(tab) {
            const previewTab = document.getElementById('preview-tab');
            const editTab = document.getElementById('edit-tab');
            const chatTab = document.getElementById('chat-tab');
            const previewBtn = document.getElementById('tab-preview');
            const editBtn = document.getElementById('tab-edit');
            const chatBtn = document.getElementById('tab-chat');
            const leftPanel = document.getElementById('left-panel');
            const rightPanel = document.getElementById('right-panel');

            // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
            previewTab.classList.add('hidden');
            editTab.classList.add('hidden');
            chatTab.classList.add('hidden');

            // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼
            previewBtn.className = 'px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-600';
            editBtn.className = 'px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-600';
            chatBtn.className = 'px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-600';

            // ì„ íƒëœ íƒ­ë§Œ í‘œì‹œ
            if (tab === 'preview') {
                previewTab.classList.remove('hidden');
                previewBtn.className = 'px-4 py-2 rounded-lg font-medium bg-purple-600 text-white';
                // â­ ì™¼ìª½ íŒ¨ë„ ë³´ì´ê¸° + ì˜¤ë¥¸ìª½ ì›ë˜ í¬ê¸°
                leftPanel.classList.remove('hidden');
                rightPanel.className = 'lg:col-span-3 space-y-6';
            } else if (tab === 'edit') {
                editTab.classList.remove('hidden');
                editBtn.className = 'px-4 py-2 rounded-lg font-medium bg-purple-600 text-white';
                document.getElementById('edit-content').value = state.generatedContent;
                // â­ ì™¼ìª½ íŒ¨ë„ ë³´ì´ê¸° + ì˜¤ë¥¸ìª½ ì›ë˜ í¬ê¸°
                leftPanel.classList.remove('hidden');
                rightPanel.className = 'lg:col-span-3 space-y-6';
            } else if (tab === 'chat') {
                chatTab.classList.remove('hidden');
                chatBtn.className = 'px-4 py-2 rounded-lg font-medium bg-purple-600 text-white';
                // â­ ì±„íŒ… íƒ­ì˜ ë¯¸ë¦¬ë³´ê¸°ì— í˜„ì¬ í¬ìŠ¤íŒ… ë‚´ìš© í‘œì‹œ
                const chatPreview = document.getElementById('chat-preview');
                chatPreview.innerHTML = document.getElementById('preview-content').innerHTML;
                // â­â­ ì™¼ìª½ íŒ¨ë„ ìˆ¨ê¸°ê¸° + ì˜¤ë¥¸ìª½ ì „ì²´ í™•ì¥
                leftPanel.classList.add('hidden');
                rightPanel.className = 'lg:col-span-5 space-y-6';
            }
        }

        // ìˆ˜ì • ì ìš©
        function applyEdit() {
            state.generatedContent = document.getElementById('edit-content').value;
            showPreview(state.generatedContent);
            switchTab('preview');
            alert('âœ… ìˆ˜ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ìˆ˜ì • ì·¨ì†Œ
        function cancelEdit() {
            switchTab('preview');
        }

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // ğŸ’¬ Claude ëŒ€í™” ê¸°ëŠ¥
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

        // ëŒ€í™” ë©”ì‹œì§€ ì¶”ê°€
        function addChatMessage(role, content, revisedContent = null) {
            const chatHistory = document.getElementById('chat-history');
            
            // ì²« ë©”ì‹œì§€ë©´ í™˜ì˜ ë©”ì‹œì§€ ì œê±°
            if (state.chatHistory.length === 0 && !revisedContent) {
                chatHistory.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = role === 'user' 
                ? 'flex justify-start' 
                : 'flex justify-end';
            
            const bubble = document.createElement('div');
            bubble.className = role === 'user'
                ? 'bg-blue-100 text-gray-800 px-4 py-3 rounded-lg max-w-[80%] shadow'
                : 'bg-purple-600 text-white px-4 py-3 rounded-lg max-w-[80%] shadow';
            
            if (role === 'user') {
                bubble.innerHTML = `<div class="flex items-start gap-2">
                    <span class="font-bold">ğŸ‘¤</span>
                    <div class="whitespace-pre-wrap">${escapeHtml(content)}</div>
                </div>`;
            } else {
                // â­ í˜„ì¬ ì¸ë±ìŠ¤ ê³ ì • (push ì „ì— ê³„ì‚°)
                const currentIndex = state.chatHistory.length;
                
                bubble.innerHTML = `<div class="flex items-start gap-2">
                    <span class="font-bold">ğŸ¤–</span>
                    <div>
                        <div class="whitespace-pre-wrap mb-3">${escapeHtml(content)}</div>
                        ${revisedContent ? `
                            <button onclick="applyChatRevision(${currentIndex})" 
                                    class="mt-2 px-4 py-2 bg-white text-purple-600 rounded font-medium hover:bg-purple-50 transition-colors">
                                âœ… ì´ ìˆ˜ì •ì‚¬í•­ ì ìš©í•˜ê¸°
                            </button>
                        ` : ''}
                    </div>
                </div>`;
            }
            
            messageDiv.appendChild(bubble);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // íˆìŠ¤í† ë¦¬ì— ì €ì¥ (ìë™ ì ìš© ì‹œì—ë§Œ)
            if (!revisedContent || role === 'user') {
                state.chatHistory.push({ role, content, revisedContent });
                console.log('ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ì €ì¥:', role, 'ì¸ë±ìŠ¤:', state.chatHistory.length - 1);
            }
        }

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì „ì†¡
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            // â­ í™•ì • í›„ì—ë„ ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ isFinalized ì²´í¬ ì œê±°
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addChatMessage('user', message);
            input.value = '';
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            const sendBtn = document.getElementById('chat-send-btn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'ë‹µë³€ ì¤‘...';
            
            // â­ Claude ì‘ë‹µ ë§í’ì„  ë¯¸ë¦¬ ìƒì„± (ìŠ¤íŠ¸ë¦¬ë°ìš©)
            const chatHistory = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-end';
            
            const bubble = document.createElement('div');
            bubble.className = 'bg-purple-600 text-white px-4 py-3 rounded-lg max-w-[80%] shadow';
            bubble.innerHTML = `
                <div class="flex items-start gap-2">
                    <span class="font-bold">ğŸ¤–</span>
                    <div>
                        <div id="streaming-text" class="whitespace-pre-wrap mb-3">
                            <span class="inline-block animate-pulse">â—</span>
                        </div>
                        <div id="streaming-button-container"></div>
                    </div>
                </div>
            `;
            
            messageDiv.appendChild(bubble);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            try {
                // âš¡ ìŠ¤íŠ¸ë¦¬ë° API í˜¸ì¶œ
                const response = await fetch('/api/revise-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentContent: state.generatedContent,
                        revisionRequest: message,
                        chatHistory: state.chatHistory,
                        originalData: state.originalData
                    })
                });
                
                if (!response.ok) {
                    throw new Error('ìˆ˜ì • ìš”ì²­ ì‹¤íŒ¨');
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let explanation = '';
                let revisedContent = '';
                let streamingTextDiv = document.getElementById('streaming-text');
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'chunk') {
                                    // âš¡ ì‹¤ì‹œê°„ìœ¼ë¡œ í…ìŠ¤íŠ¸ ì¶”ê°€
                                    explanation += data.text;
                                    streamingTextDiv.textContent = explanation;
                                    chatHistory.scrollTop = chatHistory.scrollHeight;
                                } else if (data.type === 'done') {
                                    // ì™„ë£Œ
                                    explanation = data.explanation;
                                    revisedContent = data.revisedContent;
                                    streamingTextDiv.textContent = explanation;
                                    
                                    // â­ í˜„ì¬ ì¸ë±ìŠ¤ ê³ ì • (push ì „ì— ê³„ì‚°)
                                    const currentIndex = state.chatHistory.length;
                                    
                                    // ì ìš© ë²„íŠ¼ ë™ì  ìƒì„± (ê° ë©”ì‹œì§€ë§ˆë‹¤ ë…ë¦½ì )
                                    const buttonContainer = document.getElementById('streaming-button-container');
                                    buttonContainer.innerHTML = `
                                        <button onclick="applyChatRevision(${currentIndex})" 
                                                class="mt-2 px-4 py-2 bg-white text-purple-600 rounded font-medium hover:bg-purple-50 transition-colors">
                                            âœ… ì´ ìˆ˜ì •ì‚¬í•­ ì ìš©í•˜ê¸°
                                        </button>
                                    `;
                                    
                                    // íˆìŠ¤í† ë¦¬ì— ì €ì¥
                                    state.chatHistory.push({ 
                                        role: 'assistant', 
                                        content: explanation, 
                                        revisedContent 
                                    });
                                    
                                    console.log('íˆìŠ¤í† ë¦¬ ì €ì¥ ì™„ë£Œ. ì¸ë±ìŠ¤:', currentIndex, 'revisedContent ê¸¸ì´:', revisedContent.length);
                                } else if (data.type === 'error') {
                                    throw new Error(data.message);
                                }
                            } catch (e) {
                                // JSON íŒŒì‹± ì—ëŸ¬ ë¬´ì‹œ
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error:', error);
                alert('âŒ ìˆ˜ì • ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                messageDiv.remove();  // ì—ëŸ¬ ì‹œ ë§í’ì„  ì œê±°
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'ì „ì†¡';
            }
        }

        // Claudeì˜ ìˆ˜ì •ì‚¬í•­ ì ìš©
        function applyChatRevision(index) {
            console.log('applyChatRevision í˜¸ì¶œ:', index, 'chatHistory length:', state.chatHistory.length);
            const chat = state.chatHistory[index];
            console.log('chat:', chat);
            
            if (chat && chat.revisedContent) {
                console.log('revisedContent ìˆìŒ, ê¸¸ì´:', chat.revisedContent.length);
                state.generatedContent = chat.revisedContent;
                
                // ë©”ì¸ ë¯¸ë¦¬ë³´ê¸° íƒ­ ì—…ë°ì´íŠ¸
                showPreview(state.generatedContent);
                
                // â­ ì±„íŒ… íƒ­ì˜ ë¯¸ë¦¬ë³´ê¸°ë„ ì—…ë°ì´íŠ¸ (HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬)
                const chatPreview = document.getElementById('chat-preview');
                const escapedContent = document.createElement('div');
                escapedContent.textContent = state.generatedContent;
                chatPreview.innerHTML = `<pre class="whitespace-pre-wrap text-sm bg-white p-4 rounded border border-gray-200 font-mono text-left">${escapedContent.innerHTML}</pre>`;
                
                console.log('ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                
                // ìƒíƒœ ì—…ë°ì´íŠ¸
                updateStatusBadge('ìˆ˜ì •ë¨', 'bg-yellow-500');
                
                alert('âœ… ìˆ˜ì •ì‚¬í•­ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else {
                console.error('revisedContentê°€ ì—†ìŠµë‹ˆë‹¤!', chat);
                alert('âŒ ìˆ˜ì •ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // ğŸ¯ ìˆ˜ì •ì‚¬í•­ ëˆ„ì  ì‹œìŠ¤í…œ
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

        // â­ ìˆ˜ì • ìš”ì²­ ì¶”ê°€
        function addRevisionRequest() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) {
                alert('ìˆ˜ì • ìš”ì²­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ìˆ˜ì • ìš”ì²­ ì¶”ê°€
            state.revisionRequests.push({
                id: Date.now(),
                text: message
            });
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            input.value = '';
            
            // UI ì—…ë°ì´íŠ¸
            updateRevisionList();
            
            // ì•ˆë‚´ ë©”ì‹œì§€
            if (state.revisionRequests.length === 1) {
                alert('âœ… ìˆ˜ì • ìš”ì²­ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!\nê³„ì† ìš”ì²­ì„ ì¶”ê°€í•˜ê±°ë‚˜, "ëª¨ë“  ìˆ˜ì •ì‚¬í•­ í•œë²ˆì— ë°˜ì˜" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
            }
        }

        // â­ ìˆ˜ì • ìš”ì²­ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateRevisionList() {
            const listPanel = document.getElementById('revision-list-panel');
            const list = document.getElementById('revision-list');
            const count = document.getElementById('revision-count');
            const applyAllBtn = document.getElementById('apply-all-btn');
            const chatHistory = document.getElementById('chat-history');
            
            if (state.revisionRequests.length === 0) {
                // ëª©ë¡ì´ ì—†ìœ¼ë©´ â†’ ëª©ë¡ ìˆ¨ê¸°ê³ , ëŒ€í™” íˆìŠ¤í† ë¦¬ ë³´ì´ê¸°
                listPanel.classList.add('hidden');
                applyAllBtn.classList.add('hidden');
                chatHistory.classList.remove('hidden');
                return;
            }
            
            // ëª©ë¡ì´ ìˆìœ¼ë©´ â†’ ëª©ë¡ ë³´ì´ê³ , ëŒ€í™” íˆìŠ¤í† ë¦¬ ìˆ¨ê¸°ê¸°
            listPanel.classList.remove('hidden');
            applyAllBtn.classList.remove('hidden');
            chatHistory.classList.add('hidden');
            
            // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            count.textContent = `(${state.revisionRequests.length})`;
            
            // ëª©ë¡ ë Œë”ë§
            list.innerHTML = state.revisionRequests.map((req, index) => `
                <div class="flex items-start gap-2 bg-white p-2 rounded border border-yellow-300">
                    <span class="font-bold text-purple-600 flex-shrink-0">${index + 1}.</span>
                    <span class="flex-1 text-gray-700">${escapeHtml(req.text)}</span>
                    <button onclick="removeRevisionRequest(${req.id})" class="text-red-500 hover:text-red-700 flex-shrink-0">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        // â­ ìˆ˜ì • ìš”ì²­ ì œê±°
        function removeRevisionRequest(id) {
            state.revisionRequests = state.revisionRequests.filter(r => r.id !== id);
            updateRevisionList();
        }

        // â­ ëª¨ë“  ìˆ˜ì • ìš”ì²­ ì´ˆê¸°í™”
        function clearRevisionRequests() {
            if (confirm('ëª¨ë“  ìˆ˜ì • ìš”ì²­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                state.revisionRequests = [];
                updateRevisionList();
            }
        }

        // â­â­ ëª¨ë“  ìˆ˜ì •ì‚¬í•­ í•œë²ˆì— ë°˜ì˜
        async function applyAllRevisions() {
            if (state.revisionRequests.length === 0) {
                alert('ìˆ˜ì • ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // í™•ì¸ ë©”ì‹œì§€
            if (!confirm(`${state.revisionRequests.length}ê°œì˜ ìˆ˜ì •ì‚¬í•­ì„ í•œë²ˆì— ë°˜ì˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            const applyAllBtn = document.getElementById('apply-all-btn');
            const addRevisionBtn = document.getElementById('add-revision-btn');
            applyAllBtn.disabled = true;
            addRevisionBtn.disabled = true;
            applyAllBtn.innerHTML = `
                <div class="inline-block animate-spin mr-2">âš™ï¸</div>
                ì²˜ë¦¬ ì¤‘...
            `;
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€ (ëŒ€í™”ì°½ì—)
            const combinedMessage = `ë‹¤ìŒ ${state.revisionRequests.length}ê°œì˜ ìˆ˜ì •ì‚¬í•­ì„ ëª¨ë‘ ë°˜ì˜í•´ì£¼ì„¸ìš”:\n\n` + 
                state.revisionRequests.map((req, i) => `${i+1}. ${req.text}`).join('\n');
            addChatMessage('user', combinedMessage);
            
            // â­ Claude ì‘ë‹µ ë§í’ì„  ë¯¸ë¦¬ ìƒì„± (ìŠ¤íŠ¸ë¦¬ë°ìš©)
            const chatHistory = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-end';
            
            const bubble = document.createElement('div');
            bubble.className = 'bg-purple-600 text-white px-4 py-3 rounded-lg max-w-[80%] shadow';
            bubble.innerHTML = `
                <div class="flex items-start gap-2">
                    <span class="font-bold">ğŸ¤–</span>
                    <div>
                        <div id="streaming-text" class="whitespace-pre-wrap mb-3">
                            <span class="inline-block animate-pulse">â—</span>
                        </div>
                        <div id="streaming-button-container"></div>
                    </div>
                </div>
            `;
            
            messageDiv.appendChild(bubble);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            try {
                // âš¡ ìŠ¤íŠ¸ë¦¬ë° API í˜¸ì¶œ
                const response = await fetch('/api/revise-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentContent: state.generatedContent,
                        revisionRequest: combinedMessage,
                        chatHistory: state.chatHistory,
                        originalData: state.originalData
                    })
                });
                
                if (!response.ok) {
                    throw new Error('ìˆ˜ì • ìš”ì²­ ì‹¤íŒ¨');
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let explanation = '';
                let revisedContent = '';
                let streamingTextDiv = document.getElementById('streaming-text');
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'chunk') {
                                    // âš¡ ì‹¤ì‹œê°„ìœ¼ë¡œ í…ìŠ¤íŠ¸ ì¶”ê°€
                                    explanation += data.text;
                                    streamingTextDiv.textContent = explanation;
                                    chatHistory.scrollTop = chatHistory.scrollHeight;
                                } else if (data.type === 'done') {
                                    // ì™„ë£Œ
                                    explanation = data.explanation;
                                    revisedContent = data.revisedContent;
                                    streamingTextDiv.textContent = explanation;
                                    
                                    // â­ í˜„ì¬ ì¸ë±ìŠ¤ ê³ ì • (push ì „ì— ê³„ì‚°)
                                    const currentIndex = state.chatHistory.length;
                                    
                                    // ì ìš© ë²„íŠ¼ ë™ì  ìƒì„± (ê° ë©”ì‹œì§€ë§ˆë‹¤ ë…ë¦½ì )
                                    const buttonContainer = document.getElementById('streaming-button-container');
                                    buttonContainer.innerHTML = `
                                        <button onclick="applyChatRevision(${currentIndex})" 
                                                class="mt-2 px-4 py-2 bg-white text-purple-600 rounded font-medium hover:bg-purple-50 transition-colors">
                                            âœ… ì´ ìˆ˜ì •ì‚¬í•­ ì ìš©í•˜ê¸°
                                        </button>
                                    `;
                                    
                                    // íˆìŠ¤í† ë¦¬ì— ì €ì¥
                                    state.chatHistory.push({ 
                                        role: 'assistant', 
                                        content: explanation, 
                                        revisedContent 
                                    });
                                    
                                    console.log('íˆìŠ¤í† ë¦¬ ì €ì¥ ì™„ë£Œ. ì¸ë±ìŠ¤:', currentIndex, 'revisedContent ê¸¸ì´:', revisedContent.length);
                                    
                                    // â­ ìˆ˜ì • ìš”ì²­ ëª©ë¡ ì´ˆê¸°í™”
                                    state.revisionRequests = [];
                                    updateRevisionList();
                                    
                                    alert('âœ… ëª¨ë“  ìˆ˜ì •ì‚¬í•­ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤!\n"ì´ ìˆ˜ì •ì‚¬í•­ ì ìš©í•˜ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
                                    
                                } else if (data.type === 'error') {
                                    throw new Error(data.message);
                                }
                            } catch (e) {
                                // JSON íŒŒì‹± ì—ëŸ¬ ë¬´ì‹œ
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error:', error);
                alert('âŒ ìˆ˜ì • ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                messageDiv.remove();  // ì—ëŸ¬ ì‹œ ë§í’ì„  ì œê±°
            } finally {
                applyAllBtn.disabled = false;
                addRevisionBtn.disabled = false;
                applyAllBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    ğŸ¯ ëª¨ë“  ìˆ˜ì •ì‚¬í•­ í•œë²ˆì— ë°˜ì˜
                `;
            }
        }

        // í¬ìŠ¤íŒ… í™•ì •
        function finalizeContent() {
            if (confirm('í¬ìŠ¤íŒ…ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní™•ì • í›„ì—ë„ ìˆ˜ì •ì€ ê°€ëŠ¥í•©ë‹ˆë‹¤.')) {
                state.isFinalized = true;
                
                // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
                document.getElementById('download-buttons').classList.remove('hidden');
                
                // ìƒíƒœ ì—…ë°ì´íŠ¸
                updateStatusBadge('í™•ì •ë¨', 'bg-green-500');
                
                // â­ ì…ë ¥ì°½ ë¹„í™œì„±í™” ì œê±° - í™•ì • í›„ì—ë„ ìˆ˜ì • ê°€ëŠ¥
                
                alert('âœ… í¬ìŠ¤íŒ…ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!\në‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•˜ë©°, ê³„ì† ìˆ˜ì •ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                switchTab('preview');
            }
        }

        // ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸
        function updateStatusBadge(text, bgClass) {
            const badge = document.getElementById('status-badge');
            badge.textContent = text;
            badge.className = `px-3 py-1 rounded-full text-xs font-bold text-white ${bgClass}`;
            badge.classList.remove('hidden');
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ë§ˆí¬ë‹¤ìš´ ë‹¤ìš´ë¡œë“œ
        function downloadMarkdown() {
            const blob = new Blob([state.generatedContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.keyword}_í¬ìŠ¤íŒ….md`;
            a.click();
        }

        // HTML ë‹¤ìš´ë¡œë“œ (ì¦‰ì‹œ ë³€í™˜!)
        function downloadHTML() {
            const html = convertMarkdownToHTML(state.generatedContent);  // â­ ì¦‰ì‹œ ë³€í™˜
            const blob = new Blob([html], { type: 'text/html; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.keyword}_í¬ìŠ¤íŒ….html`;
            a.click();
        }

        // ë§ˆí¬ë‹¤ìš´ â†’ HTML ë³€í™˜ (ë„¤ì´ë²„ ë¸”ë¡œê·¸ ì½”ë“œ í¸ì§‘ê¸°ìš©)
        function convertMarkdownToHTML(markdown) {
            const lines = markdown.split('\n');
            let html = '';
            let inTable = false;
            let isTableHeader = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmed = line.trim();
                
                // H1 ì œëª©
                if (trimmed.startsWith('# ')) {
                    const text = trimmed.substring(2);
                    html += `<h1 style="font-size: 35px; font-weight: 700; color: #4a148c; margin-top: 1.5em; margin-bottom: 0.8em; line-height: 1.2; border-bottom: 3px solid #7b1fa2; padding-bottom: 0.3em; font-family: 'Noto Sans KR', sans-serif;">\n${text}\n</h1>\n<br>\n`;
                }
                // â­ í›„í‚¹ ì§ˆë¬¸ (BLOCKQUOTE) - ## ë˜ëŠ” ### ë¡œ ì‹œì‘í•˜ê³  ?ë¡œ ëë‚˜ëŠ” ê²ƒ
                else if ((trimmed.startsWith('## ') || trimmed.startsWith('### ')) && trimmed.endsWith('?')) {
                    let questionText = trimmed;
                    if (questionText.startsWith('### ')) {
                        questionText = questionText.substring(4);
                    } else if (questionText.startsWith('## ')) {
                        questionText = questionText.substring(3);
                    }
                    html += `<blockquote style="background: #f3e5f5; border-left: 5px solid #4a148c; padding: 20px; font-size: 24px; line-height: 1.8; text-align: center; font-weight: 700; margin: 0; font-style: italic; color: #4a148c; font-family: 'Noto Sans KR', sans-serif;">\n${questionText}\n</blockquote>\n<br>\n`;
                }
                // H2 ì„¹ì…˜ ì œëª©
                else if (trimmed.startsWith('## ')) {
                    const text = trimmed.substring(3);
                    html += `<br><br>\n<h2 style="font-size: 34px; font-weight: 700; color: #ffffff; background-color: #6a1b9a; border: 2px solid #6a1b9a; margin-top: 1.5em; margin-bottom: 0.8em; line-height: 1.2; padding: 0.6em 0.8em; font-family: 'Noto Sans KR', sans-serif;">\n${text}\n</h2>\n<br>\n`;
                }
                // H3 í•˜ìœ„ ì œëª©
                else if (trimmed.startsWith('### ')) {
                    const text = trimmed.substring(4);
                    html += `<br>\n<h3 style="font-size: 24px; font-weight: 700; color: #4a148c; margin-top: 1.5em; margin-bottom: 0.8em; line-height: 1.2; border: 1px solid #f3e5f5; border-left: 5px solid #9c27b0; padding: 0.6em 0.8em; font-family: 'Noto Sans KR', sans-serif;">\n${text}\n</h3>\n<br>\n`;
                }
                // Blockquote ì²˜ë¦¬ (> ë¡œ ì‹œì‘)
                else if (trimmed.startsWith('> ')) {
                    let quoteText = trimmed.substring(2).trim();
                    
                    // > ## ì§ˆë¬¸? í˜•íƒœ ì²˜ë¦¬
                    if (quoteText.startsWith('### ')) {
                        quoteText = quoteText.substring(4);
                    } else if (quoteText.startsWith('## ')) {
                        quoteText = quoteText.substring(3);
                    } else if (quoteText.startsWith('# ')) {
                        quoteText = quoteText.substring(2);
                    }
                    
                    html += `<blockquote style="background: #f3e5f5; border-left: 5px solid #4a148c; padding: 20px; font-size: 24px; line-height: 1.8; text-align: center; font-weight: 700; margin: 0; font-style: italic; color: #4a148c; font-family: 'Noto Sans KR', sans-serif;">\n${quoteText}\n</blockquote>\n`;
                }
                // í‘œ ì‹œì‘
                else if (trimmed.startsWith('|')) {
                    if (!inTable) {
                        html += '<table style="width: 100%; border-collapse: collapse; margin: 1.5em 0; font-family: \'Noto Sans KR\', sans-serif;">\n';
                        inTable = true;
                        isTableHeader = true;
                    }
                    
                    const cells = trimmed.split('|').filter(c => c.trim());
                    
                    // êµ¬ë¶„ì„  skip
                    if (cells.some(c => c.includes('---'))) {
                        isTableHeader = false;
                        continue;
                    }
                    
                    html += '<tr>\n';
                    cells.forEach(cell => {
                        if (isTableHeader) {
                            html += `<th style="border: 1px solid #e1bee7; padding: 0.5em; text-align: center; background-color: #9c27b0; color: white; font-weight: 700; font-size: 18px;">${cell.trim()}</th>\n`;
                        } else {
                            html += `<td style="border: 1px solid #e1bee7; padding: 0.5em; text-align: center; font-size: 19px;">${cell.trim()}</td>\n`;
                        }
                    });
                    html += '</tr>\n';
                }
                // í‘œ ë
                else if (inTable && !trimmed.startsWith('|')) {
                    html += '</table>\n<br>\n';
                    inTable = false;
                    isTableHeader = false;
                }
                // ì´ë¯¸ì§€ í‘œì‹œ - â­ ë³´ë¼ìƒ‰ í…ìŠ¤íŠ¸ë¡œ (íšŒìƒ‰ ë°•ìŠ¤ ì œê±°!)
                else if (trimmed.includes('[ì´ë¯¸ì§€:') || trimmed.includes('[GIF:') || trimmed.includes('[ì¸ë„¤ì¼:') || trimmed.includes('[ë°°ë„ˆ:')) {
                    html += `<p style="text-align: center; font-weight: 700; color: #9c27b0; font-size: 17px; margin: 20px 0; font-family: 'Noto Sans KR', sans-serif;">\n${trimmed}\n</p>\n<br>\n`;
                }
                // ì¼ë°˜ í…ìŠ¤íŠ¸
                else if (trimmed) {
                    // ë³¼ë“œ ì²˜ë¦¬
                    let processed = trimmed.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                    html += `<p style="font-size: 19px; line-height: 1.8; margin-bottom: 0; color: #333; font-family: 'Noto Sans KR', sans-serif;">\n${processed}\n</p>\n<br>\n`;
                }
                // ë¹ˆ ì¤„
                else {
                    html += '<br>\n';
                }
            }
            
            if (inTable) html += '</table>\n';
            
            return html;
        }

        // ë³µì‚¬
        function copyToClipboard() {
            navigator.clipboard.writeText(state.generatedContent);
            alert('âœ… í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
    </script>

</body>
</html>
